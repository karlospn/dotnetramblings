<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Building an Async HTTP Api with Azure Durable Functions and Python :: my tech ramblings — A blog for writing about my techie ramblings</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Just show me the code
As always if you don’t care about the post I have upload the source code on my Github.
In today&amp;rsquo;s post I&amp;rsquo;ll be showing you how to implement the Async HTTP Api pattern with Azure Durable functions.
Also, most of the online examples and documentation about Durable Functions are written with csharp so instead of that I have decided to use Python.
To begin with, let&amp;rsquo;s do a brief explanation about a few key concepts around Azure Durable Functions."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://www.mytechramblings.com/posts/building-an-async-http-api-with-durable-functions-and-python/" />





<link rel="stylesheet" href="https://www.mytechramblings.com/assets/style.css">


<link rel="stylesheet" href="https://www.mytechramblings.com/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.mytechramblings.com/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://www.mytechramblings.com/img/favicon.png">


<meta name="twitter:card" content="summary"/><meta name="twitter:title" content="Building an Async HTTP Api with Azure Durable Functions and Python"/>
<meta name="twitter:description" content="The async HTTP API pattern addresses the problem of coordinating the state of long-running operations with external clients. Azure Durable Functions provides built-in support for this pattern and in this post I&#39;m going to show you how to implement it using Python."/>



<meta property="og:title" content="Building an Async HTTP Api with Azure Durable Functions and Python" />
<meta property="og:description" content="The async HTTP API pattern addresses the problem of coordinating the state of long-running operations with external clients. Azure Durable Functions provides built-in support for this pattern and in this post I&#39;m going to show you how to implement it using Python." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.mytechramblings.com/posts/building-an-async-http-api-with-durable-functions-and-python/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-15T11:20:04+01:00" />
<meta property="article:modified_time" content="2021-12-15T11:20:04+01:00" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://www.mytechramblings.com/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">my tech ramblings</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://www.mytechramblings.com/posts/building-an-async-http-api-with-durable-functions-and-python/">Building an Async HTTP Api with Azure Durable Functions and Python</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2021-12-15
        </span>

        
          
            



          
        
      

      
      
        <span class="post-read-time">— 11 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://www.mytechramblings.com/tags/azure/">azure</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/functions/">functions</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/serverless/">serverless</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/python/">python</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <blockquote>
<p><strong>Just show me the code</strong><br>
As always if you don’t care about the post I have upload the source code on my <a href="https://github.com/karlospn/az-durable-func-async-http-api-python">Github</a>.</p>
</blockquote>
<p>In today&rsquo;s post I&rsquo;ll be showing you how to implement the Async HTTP Api pattern with Azure Durable functions.</p>
<p>Also, most of the online examples and documentation about Durable Functions are written with csharp so instead of that I have decided to use Python.</p>
<p>To begin with, let&rsquo;s do a brief explanation about a few key concepts around Azure Durable Functions.</p>
<h1 id="1-azure-durable-functions">1. Azure Durable Functions</h1>
<p>For those unaware of Azure Durable Functions, it is an extension of Azure Functions that lets you write stateful functions in a serverless compute environment.<br>
The extension lets you define stateful workflows by writing orchestrator functions and stateful entities.</p>
<p>The 4 main concepts you should know about are:</p>
<ul>
<li><strong>Client functions</strong></li>
</ul>
<p>The client function is responsible for starting, stopping and monitoring the orchestrator functions.</p>
<ul>
<li><strong>Orchestrator functions</strong></li>
</ul>
<p>This function is the heart when building a durable function solution. In this function you write your workflow in code. The workflow can consist of code statements calling other functions like activity functions, other orchestration functions or even wait for other events to occur.</p>
<p>An orchestration is started by a client function, a function that on its turn can be triggered by a message in a queue, an HTTP request, or any other trigger mechanism you are familiar with.</p>
<p>Every instance of an orchestration function will have an instance identifier, which can be auto-generated or user-generated.</p>
<ul>
<li><strong>Activity functions</strong></li>
</ul>
<p>These activity functions are the basic unit of work in a durable function solution. <br>
Each activity function executes one task and can be anything you want.</p>
<ul>
<li><strong>Entity functions</strong></li>
</ul>
<p>Entity functions define operations for reading and updating small pieces of state. We often refer to these stateful entities as durable entities.</p>
<p>Like orchestrator functions, entity functions are functions with a special trigger type, entity trigger. They can also be invoked from client functions or from orchestrator functions.</p>
<p>Unlike orchestrator functions, entity functions do not have any specific code constraints. Entity functions also manage state explicitly rather than implicitly representing state via control flow.</p>
<h1 id="2-problem-trying-to-solve-with-azure-durable-functions">2. Problem trying to solve with Azure Durable functions</h1>
<p>In this section I&rsquo;ll like to talk a little bit about what I was trying to solve using Durable functions and why Durable functions was a good fit.</p>
<p>One of my clients has an HTTP API that uses an Azure Function as its backend, the function takes a few parameters via querystring, runs a query against an Azure Storage Table and returns a result. It&rsquo;s a really simple setup.</p>
<p><img alt="audit-api" src="/img/audit-function-durable.png"></p>
<p>The problem with this approach lies in the fact that the query takes between 3 and 7 minutes to complete, so most of the time the HTTP function times out because 230 seconds is the maximum amount of time that an HTTP triggered function can take to respond to a request. This is because of the idle timeout of Azure Load Balancer.</p>
<p>For longer processing times, I needed to consider using an async pattern or defer the actual work and return an immediate response.<br>
And Azure Durable Functions provides built-in support for the async http api pattern.</p>
<h1 id="3-async-http-api-pattern">3. Async HTTP API Pattern</h1>
<p>The async HTTP API pattern addresses the problem of coordinating the state of long-running operations with external clients.</p>
<p>A common way to implement this pattern is by having an HTTP endpoint trigger the long-running action. Then, redirect the client to a status endpoint that the client polls to learn when the operation is finished.</p>
<p><img alt="async-http-pattern" src="/img/async-http-api-pattern.png"></p>
<h1 id="4-scenario">4. Scenario</h1>
<p>The idea behind what we&rsquo;re going to build is the following one:</p>
<ul>
<li>The customer submits a job by calling an Azure Function that has an HTTP endpoint trigger. This is the Client Function.</li>
<li>The submitted job is going to be picked up by the Orchestrator Function and it will call the Activity Function.</li>
<li>The Activity Function is going to run the query against the Azure Storage Table and return the result.</li>
<li>There is going to be an extra Azure Function that queries the orchestrator function and retrieves the status and the result of a given job.</li>
</ul>
<p>Here&rsquo;s a diagram:</p>
<p><img alt="async-http-api" src="/img/durable-function-async-http-api.png"></p>
<ul>
<li><code>client-function</code>: submits the job that needs to be executed.</li>
<li><code>get-status-function</code>: it is used to retrieve the status and the result of a given job.</li>
<li><code>orchestrator-function</code>: Unwraps the parameters from the submitted job and calls the activity function.</li>
<li><code>query-storage-account-activity-function</code>: Runs a custom query in an Azure Storage Table.</li>
</ul>
<h1 id="5-implementation">5. Implementation</h1>
<p>The components of the solution are described in the previous section. Now let&rsquo;s start building them.</p>
<h1 id="client-function">client-function</h1>
<p>This is an Http triggered function.</p>
<p>The function receives 2 parameters via QueryString (those parameters are needed to build the query against the Storage Table) and validates both of them.</p>
<p>Afterwards, it creates a <code>DurableOrchestrationClient</code> and starts a new orchestration instance using the <code>start_new</code> method.<br>
The <code>start_new</code> method takes 3 parameters:</p>
<ul>
<li>Name: The name of the orchestrator function to schedule.</li>
<li>InstanceId: (Optional) The unique ID of the instance. If you don&rsquo;t specify this parameter, the method uses a random ID.</li>
<li>Input: Any JSON-serializable data that should be passed as the input to the orchestrator function.</li>
</ul>
<p>And lastly, it builds the URL from where the client can retrieve the status and the result of the submitted job.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> azure.functions <span style="color:#66d9ef">as</span> func
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> azure.durable_functions <span style="color:#66d9ef">as</span> df
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> dateutil.parser
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> urllib.parse <span style="color:#f92672">import</span> urlparse
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(req: func<span style="color:#f92672">.</span>HttpRequest, starter: str) <span style="color:#f92672">-&gt;</span> func<span style="color:#f92672">.</span>HttpResponse:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> { }
</span></span><span style="display:flex;"><span>    headers <span style="color:#f92672">=</span> { <span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;application/json&#34;</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    start_date <span style="color:#f92672">=</span> req<span style="color:#f92672">.</span>params<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;s&#39;</span>)
</span></span><span style="display:flex;"><span>    end_date <span style="color:#f92672">=</span> req<span style="color:#f92672">.</span>params<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;e&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> start_date:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>          start_date <span style="color:#f92672">=</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(start_date, dayfirst<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>          response[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Invalid start date format.&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> func<span style="color:#f92672">.</span>HttpResponse(json<span style="color:#f92672">.</span>dumps(response) ,headers<span style="color:#f92672">=</span>headers, status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">400</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        response[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Empty start date.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> func<span style="color:#f92672">.</span>HttpResponse(json<span style="color:#f92672">.</span>dumps(response) ,headers<span style="color:#f92672">=</span>headers, status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">400</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> end_date:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>          end_date <span style="color:#f92672">=</span> dateutil<span style="color:#f92672">.</span>parser<span style="color:#f92672">.</span>parse(end_date, dayfirst<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>          response[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Invalid end date format.&#34;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">return</span> func<span style="color:#f92672">.</span>HttpResponse(json<span style="color:#f92672">.</span>dumps(response) ,headers<span style="color:#f92672">=</span>headers, status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">400</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>        response[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Empty end date.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> func<span style="color:#f92672">.</span>HttpResponse(json<span style="color:#f92672">.</span>dumps(response) ,headers<span style="color:#f92672">=</span>headers, status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">400</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    delta <span style="color:#f92672">=</span> end_date <span style="color:#f92672">-</span> start_date
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> delta<span style="color:#f92672">.</span>days <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>        response[<span style="color:#e6db74">&#39;error&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Invalid date range.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> func<span style="color:#f92672">.</span>HttpResponse(json<span style="color:#f92672">.</span>dumps(response) ,headers<span style="color:#f92672">=</span>headers, status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">400</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    client <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>DurableOrchestrationClient(starter)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parameters <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;start&#34;</span>: start_date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;end&#34;</span>: end_date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    instance_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> client<span style="color:#f92672">.</span>start_new(<span style="color:#e6db74">&#39;orchestrator-function&#39;</span>, <span style="color:#66d9ef">None</span>, parameters)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    status_uri <span style="color:#f92672">=</span> build_api_url(urlparse(req<span style="color:#f92672">.</span>url)<span style="color:#f92672">.</span>scheme, req<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;host&#34;</span>), instance_id)
</span></span><span style="display:flex;"><span>    response[<span style="color:#e6db74">&#34;statusUri&#34;</span>] <span style="color:#f92672">=</span> status_uri
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> func<span style="color:#f92672">.</span>HttpResponse(json<span style="color:#f92672">.</span>dumps(response), headers<span style="color:#f92672">=</span>headers, status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">200</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">build_api_url</span>(scheme, host, instance_id):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">{</span>scheme<span style="color:#e6db74">}</span><span style="color:#e6db74">://</span><span style="color:#e6db74">{</span>host<span style="color:#e6db74">}</span><span style="color:#e6db74">/api/status/</span><span style="color:#e6db74">{</span>instance_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div><h1 id="get-status-function">get-status-function</h1>
<h2 id="is-this-function-really-needed">Is this function really needed?</h2>
<p>Before discussing the implementation of this Azure Function, I think it&rsquo;s important to talk a bit about if this function is really needed or not.</p>
<p>Most of the examples that you are going to find online don&rsquo;t use a custom function to retrieve the status of the jobs. Instead of that, they use the <code>create_check_status_response</code> method on the Client Function.</p>
<p>That means that in the previous section I could have built the client function like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    client <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>DurableOrchestrationClient(starter)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parameters <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;start&#34;</span>: start_date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;end&#34;</span>: end_date<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    instance_id <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> client<span style="color:#f92672">.</span>start_new(<span style="color:#e6db74">&#39;orchestrator-function&#39;</span>, <span style="color:#66d9ef">None</span>, parameters)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> client<span style="color:#f92672">.</span>create_check_status_response(req, instance_id)
</span></span></code></pre></div><p>And that&rsquo;s how the function would have responded:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;b78244c9e19f43e89e7b1578f711940d&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;statusQueryGetUri&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost:7071/runtime/webhooks/durabletask/instances/b78244c9e19f43e89e7b1578f711940d?taskHub=TestHubName&amp;connection=Storage&amp;code=V/xX4rraZaheGNwbMePOhhGtyHxGsgks4Q36WKBdS3WfiOjD5Sb5lw==&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;sendEventPostUri&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost:7071/runtime/webhooks/durabletask/instances/b78244c9e19f43e89e7b1578f711940d/raiseEvent/{eventName}?taskHub=TestHubName&amp;connection=Storage&amp;code=V/xX4rraZaheGNwbMePOhhGtyHxGsgks4Q36WKBdS3WfiOjD5Sb5lw==&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;terminatePostUri&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost:7071/runtime/webhooks/durabletask/instances/b78244c9e19f43e89e7b1578f711940d/terminate?reason={text}&amp;taskHub=TestHubName&amp;connection=Storage&amp;code=V/xX4rraZaheGNwbMePOhhGtyHxGsgks4Q36WKBdS3WfiOjD5Sb5lw==&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;rewindPostUri&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost:7071/runtime/webhooks/durabletask/instances/b78244c9e19f43e89e7b1578f711940d/rewind?reason={text}&amp;taskHub=TestHubName&amp;connection=Storage&amp;code=V/xX4rraZaheGNwbMePOhhGtyHxGsgks4Q36WKBdS3WfiOjD5Sb5lw==&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;purgeHistoryDeleteUri&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost:7071/runtime/webhooks/durabletask/instances/b78244c9e19f43e89e7b1578f711940d?taskHub=TestHubName&amp;connection=Storage&amp;code=V/xX4rraZaheGNwbMePOhhGtyHxGsgks4Q36WKBdS3WfiOjD5Sb5lw==&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;restartPostUri&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;http://localhost:7071/runtime/webhooks/durabletask/instances/b78244c9e19f43e89e7b1578f711940d/restart?taskHub=TestHubName&amp;connection=Storage&amp;code=V/xX4rraZaheGNwbMePOhhGtyHxGsgks4Q36WKBdS3WfiOjD5Sb5lw==&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As you can see the <code>create_check_status_response</code> method returns a response that contains links to the various management operations that can be invoked on an orchestration instance.<br>
These operations include querying the orchestration status, raising events or terminating the orchestration.</p>
<blockquote>
<p>So, why I&rsquo;m building an extra Azure Function to retrieve the status of a job instead of directly using the <code>create_check_status_response</code> method?</p>
</blockquote>
<p>This is because the general public shouldn’t be able to query the Orchestration status endpoint directly.<br>
As you can see the response payload includes the orchestrator management endpoints with their corresponding keys, by providing that, you would allow the clients not only to get the status of a running instance, but also to get the execution history, send external events to the orchestration instance or terminate that instance.</p>
<p>Basically if you don’t want your clients messing around with the heart of the function, you need to expose another azure function that returns only the minimum information required.</p>
<h2 id="implementation">Implementation</h2>
<p>The <code>get-status-function</code> is an Http triggered function.</p>
<p>This function needs the <code>instance_id</code> that the Client function generated when submitting the job to the orchestrator function.</p>
<p>To retrieve the status and the result of a submitted job you can use the <code>get_status</code> method. This method queries the orchestrator function to obtain the status of the job.</p>
<p>The <code>get_status</code>  returns an object with the following properties:</p>
<ul>
<li>Name: The name of the orchestrator function.</li>
<li>InstanceId: The instance ID of the orchestration (should be the same as the instanceId input).</li>
<li>CreatedTime: The time at which the orchestrator function started running.</li>
<li>LastUpdatedTime: The time at which the orchestration last checkpointed.</li>
<li>Input: The input of the function as a JSON value. This field isn&rsquo;t populated if showInput is false.</li>
<li>CustomStatus: Custom orchestration status in JSON format.</li>
<li>Output: The output of the function as a JSON value (if the function has completed). If the orchestrator function failed, this property includes the failure details. If the orchestrator function was terminated, this property includes the reason for the termination (if any).</li>
<li>RuntimeStatus: One of the following values:
<ul>
<li>Pending: The instance has been scheduled but has not yet started running.</li>
<li>Running: The instance has started running.</li>
<li>Completed: The instance has completed normally.</li>
<li>ContinuedAsNew: The instance has restarted itself with a new history. This state is a transient state.</li>
<li>Failed: The instance failed with an error.</li>
<li>Terminated: The instance was stopped abruptly.</li>
</ul>
</li>
<li>History: The execution history of the orchestration. This field is only populated if showHistory is set to true.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> azure.functions <span style="color:#66d9ef">as</span> func
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> azure.durable_functions <span style="color:#66d9ef">as</span> df
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(req: func<span style="color:#f92672">.</span>HttpRequest, starter: str) <span style="color:#f92672">-&gt;</span> func<span style="color:#f92672">.</span>HttpResponse:
</span></span><span style="display:flex;"><span>    client <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>DurableOrchestrationClient(starter)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    instance_id <span style="color:#f92672">=</span> req<span style="color:#f92672">.</span>route_params[<span style="color:#e6db74">&#34;id&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> client<span style="color:#f92672">.</span>get_status(instance_id)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> response<span style="color:#f92672">.</span>instance_id <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> func<span style="color:#f92672">.</span>HttpResponse(<span style="color:#e6db74">&#34;Job not found&#34;</span>, status_code<span style="color:#f92672">=</span><span style="color:#ae81ff">404</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> func<span style="color:#f92672">.</span>HttpResponse(json<span style="color:#f92672">.</span>dumps({
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;id&#34;</span>: response<span style="color:#f92672">.</span>instance_id,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;status&#34;</span>: response<span style="color:#f92672">.</span>runtime_status<span style="color:#f92672">.</span>value,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;result&#34;</span>: response<span style="color:#f92672">.</span>output
</span></span><span style="display:flex;"><span>    }))
</span></span></code></pre></div><h1 id="orchestrator-function">orchestrator-function</h1>
<p>Nothing fancy here. The orchestrator function in this application is really simple because there is no need to orchestrate multiple activies nor build a complex workflow.</p>
<p>The function does the following steps:</p>
<ul>
<li>Retrieves the inputs send from the Client Function (These parameters are needed to build the query against the Azure Table Storage)</li>
<li>Calls the activity function passing the retrieved inputs.</li>
<li>Waits for the activity function to end and returns the result.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> azure.durable_functions <span style="color:#66d9ef">as</span> df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">orchestrator_function</span>(context: df<span style="color:#f92672">.</span>DurableOrchestrationContext):
</span></span><span style="display:flex;"><span>    input <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>get_input()
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span> context<span style="color:#f92672">.</span>call_activity(<span style="color:#e6db74">&#39;query-storage-account-activity-function&#39;</span>, {<span style="color:#e6db74">&#39;start&#39;</span>: input[<span style="color:#e6db74">&#39;start&#39;</span>], <span style="color:#e6db74">&#39;end&#39;</span>: input[<span style="color:#e6db74">&#39;end&#39;</span>]})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>main <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>Orchestrator<span style="color:#f92672">.</span>create(orchestrator_function)
</span></span></code></pre></div><h1 id="query-storage-account-activity-function">query-storage-account-activity-function</h1>
<p>This Activity Function is responsible to run the query against the Azure Table Storage.</p>
<p>This function retrieves the Storage Table connection string from an App Configuration with a Key Vault reference (<a href="https://docs.microsoft.com/en-us/azure/azure-app-configuration/overview)">https://docs.microsoft.com/en-us/azure/azure-app-configuration/overview)</a>, runs the query and returns the result.</p>
<p>As you can see this function is a single unit of work and does not contain any reference to the durable-functions library.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> azure.appconfiguration <span style="color:#f92672">import</span> AzureAppConfigurationClient
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> azure.identity <span style="color:#f92672">import</span> DefaultAzureCredential
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> azure.keyvault.secrets <span style="color:#f92672">import</span> SecretClient
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> azure.data.tables <span style="color:#f92672">import</span> TableClient
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pathlib <span style="color:#f92672">import</span> Path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>(request: dict) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">=</span> request[<span style="color:#e6db74">&#39;start&#39;</span>]
</span></span><span style="display:flex;"><span>    end   <span style="color:#f92672">=</span> request[<span style="color:#e6db74">&#39;end&#39;</span>]
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    table_conn_str <span style="color:#f92672">=</span> get_azure_table_connection_string()
</span></span><span style="display:flex;"><span>    response <span style="color:#f92672">=</span> run_query(start, end, table_conn_str)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> response
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_query</span>(start, end, table_conn_str) <span style="color:#f92672">-&gt;</span> int:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    items <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>    client <span style="color:#f92672">=</span>  TableClient<span style="color:#f92672">.</span>from_connection_string(conn_str<span style="color:#f92672">=</span>table_conn_str, table_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;audit&#34;</span>) 
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    parameters <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;start&#34;</span>: start,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;end&#34;</span>: end
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>           
</span></span><span style="display:flex;"><span>    query_filter <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PartitionKey ge @start and PartitionKey le @end and CertNumber ne &#39;&#39;&#34;</span>
</span></span><span style="display:flex;"><span>    entities <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>query_entities(query_filter, parameters<span style="color:#f92672">=</span>parameters, select<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;identificationNumber&#39;</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> entity <span style="color:#f92672">in</span> entities:
</span></span><span style="display:flex;"><span>        items<span style="color:#f92672">.</span>append(entity[<span style="color:#e6db74">&#39;identificationNumber&#39;</span>])
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> len(set(items))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_azure_table_connection_string</span>() <span style="color:#f92672">-&gt;</span> str:
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    defaultAzureCredential <span style="color:#f92672">=</span> DefaultAzureCredential()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    app_config_base_url <span style="color:#f92672">=</span> os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;AppConfigEndpoint&#39;</span>)
</span></span><span style="display:flex;"><span>    app_config_client <span style="color:#f92672">=</span> AzureAppConfigurationClient(base_url<span style="color:#f92672">=</span>app_config_base_url, credential<span style="color:#f92672">=</span>defaultAzureCredential)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    keyvault_value <span style="color:#f92672">=</span> app_config_client<span style="color:#f92672">.</span>get_configuration_setting(key<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;storage-account-connection-string&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;async-http-api&#34;</span>)
</span></span><span style="display:flex;"><span>    url_parts <span style="color:#f92672">=</span> Path(json<span style="color:#f92672">.</span>loads(keyvault_value<span style="color:#f92672">.</span>value)[<span style="color:#e6db74">&#34;uri&#34;</span>])<span style="color:#f92672">.</span>parts
</span></span><span style="display:flex;"><span>    vault_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;//&#34;</span><span style="color:#f92672">.</span>join(url_parts[:<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>    kv_secret <span style="color:#f92672">=</span> url_parts[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>    kv_client <span style="color:#f92672">=</span> SecretClient(vault_url, defaultAzureCredential)
</span></span><span style="display:flex;"><span>    secret_val <span style="color:#f92672">=</span> kv_client<span style="color:#f92672">.</span>get_secret(kv_secret)<span style="color:#f92672">.</span>value
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> secret_val
</span></span></code></pre></div><h1 id="6-test">6. Test</h1>
<p>Everything is put in place, now let&rsquo;s test it.</p>
<p>If I try to submit a new job with a few invalid parameters, it responds with an error:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://func-sa-table-durable-dev.azurewebsites.net/api/submit/query&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Empty start date.&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://func-sa-table-durable-dev.azurewebsites.net/api/submit/query?s=10/08/2021&amp;e=abcd&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Invalid end date format.&#34;</span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://func-sa-table-durable-dev.azurewebsites.net/api/submit/query?s=10/08/2021&amp;e=05/08/2021&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;error&#34;</span>: <span style="color:#e6db74">&#34;Invalid date range.&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>If I try to submit a new job with valid parameters, the client function responds with the status endpoint.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://func-sa-table-durable-dev.azurewebsites.net/api/submit/query?s=10/10/2021&amp;e=10/12/2021&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;statusUri&#34;</span>: <span style="color:#e6db74">&#34;https://func-sa-table-durable-dev.azurewebsites.net/api/status/433ebcfe85ec4012abe94dcda2aa6b00&#34;</span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>If I query the get-status function right away, it returns that the job is still being executed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://func-sa-table-durable-dev.azurewebsites.net/api/status/433ebcfe85ec4012abe94dcda2aa6b00&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;433ebcfe85ec4012abe94dcda2aa6b00&#34;</span>, <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;Running&#34;</span>, <span style="color:#e6db74">&#34;result&#34;</span>: null<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>If I query the get-status function after a few minutes, the job has completed and we can see the result.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl <span style="color:#e6db74">&#34;https://func-sa-table-durable-dev.azurewebsites.net/api/status/433ebcfe85ec4012abe94dcda2aa6b00&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span><span style="color:#e6db74">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;433ebcfe85ec4012abe94dcda2aa6b00&#34;</span>, <span style="color:#e6db74">&#34;status&#34;</span>: <span style="color:#e6db74">&#34;Completed&#34;</span>, <span style="color:#e6db74">&#34;result&#34;</span>: 119<span style="color:#f92672">}</span>
</span></span></code></pre></div><h1 id="7-deployment-to-azure">7. Deployment to Azure</h1>
<p>I didn&rsquo;t plan to write about how to deploy these functions to Azure, but it might be useful to someone.</p>
<p>Here&rsquo;s how you can deploy them using:</p>
<ul>
<li>Azure DevOps pipelines</li>
<li>Github Actions</li>
</ul>
<h2 id="using-azure-pipelines">Using Azure Pipelines</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">trigger</span>: <span style="color:#ae81ff">none</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">pool</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vmImage</span>: <span style="color:#e6db74">&#39;ubuntu-latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">azureSubscription</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;cpons-demos-dev&#39;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">name</span>: <span style="color:#ae81ff">functionAppName</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">value</span>: <span style="color:#e6db74">&#39;func-staccount-report-query-dev&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">steps</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">UsePythonVersion@0</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">inputs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">versionSpec</span>: <span style="color:#e6db74">&#39;3.8&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Use Python 3.8&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    python -m pip install --upgrade pip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    pip install --target=&#34;./.python_packages/lib/site-packages&#34; -r ./requirements.txt</span>    
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Install dependencies&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">CopyFiles@2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">inputs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">SourceFolder</span>: <span style="color:#e6db74">&#39;$(Build.SourcesDirectory)&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">Contents</span>: <span style="color:#e6db74">&#39;**&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">TargetFolder</span>: <span style="color:#e6db74">&#39;$(Build.ArtifactStagingDirectory)&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">ArchiveFiles@2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">inputs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rootFolderOrFile</span>: <span style="color:#e6db74">&#39;$(Build.ArtifactStagingDirectory)&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">includeRootFolder</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">archiveType</span>: <span style="color:#e6db74">&#39;zip&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">archiveFile</span>: <span style="color:#e6db74">&#39;$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">replaceExistingArchive</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">AzureFunctionApp@1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">inputs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">azureSubscription</span>: <span style="color:#e6db74">&#39;$(azureSubscription)&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">appType</span>: <span style="color:#e6db74">&#39;functionAppLinux&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">appName</span>: <span style="color:#e6db74">&#39;$(functionAppName)&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">package</span>: <span style="color:#e6db74">&#39;$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runtimeStack</span>: <span style="color:#e6db74">&#39;PYTHON|3.8&#39;</span>
</span></span></code></pre></div><h2 id="using-github-action">Using Github Action</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">name</span>: <span style="color:#ae81ff">Deploy Durable Functions to Azure Function App</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">on</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">push</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">branches</span>: [ <span style="color:#ae81ff">main ]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">workflow_dispatch</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">AZURE_FUNCTIONAPP_NAME</span>: <span style="color:#ae81ff">func-staccount-report-query-dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">AZURE_FUNCTIONAPP_PACKAGE_PATH</span>: <span style="color:#e6db74">&#39;.&#39;</span>   
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">PYTHON_VERSION</span>: <span style="color:#e6db74">&#39;3.8&#39;</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span><span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">build-and-deploy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">runs-on</span>: <span style="color:#ae81ff">ubuntu-latest</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;Checkout GitHub Action&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/checkout@master</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">Setup Python ${{ env.PYTHON_VERSION }} Environment</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">actions/setup-python@v1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">python-version</span>: <span style="color:#ae81ff">${{ env.PYTHON_VERSION }}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;Resolve Project Dependencies Using Pip&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">shell</span>: <span style="color:#ae81ff">bash</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">run</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pushd &#39;./${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        python -m pip install --upgrade pip
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        pip install -r requirements.txt --target=&#34;.python_packages/lib/site-packages&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        popd</span>        
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;Run Azure Functions Action&#39;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">uses</span>: <span style="color:#ae81ff">Azure/functions-action@v1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">id</span>: <span style="color:#ae81ff">fa</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">with</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app-name</span>: <span style="color:#ae81ff">${{ env.AZURE_FUNCTIONAPP_NAME }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">package</span>: <span style="color:#ae81ff">${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">publish-profile</span>: <span style="color:#ae81ff">${{ secrets.SCM_CREDENTIALS }}</span>
</span></span></code></pre></div>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://www.mytechramblings.com/posts/getting-started-with-aws-distro-for-otel-and-dotnet-part-1/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Getting started with AWS Distro for OpenTelemetry and distributed tracing using .NET. Part 1: Setting up the AWS OTEL Collector</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://www.mytechramblings.com/posts/testing-container-vulnerabilities-scanners-using-azure-pipelines/">
                  <span class="button__text">Testing how to use some container vulnerabilities scanners with Azure Pipelines</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2024 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://www.mytechramblings.com/assets/main.js"></script>
<script src="https://www.mytechramblings.com/assets/prism.js"></script>
<script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
<script>
  kofiWidgetOverlay.draw('carlospons', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Donate',
    'floating-chat.donateButton.background-color': '#ff5f5f',
    'floating-chat.donateButton.text-color': '#fff'
  });
</script>

      
    </div>

    
      
<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-170300931-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
    
  </body>
</html>
