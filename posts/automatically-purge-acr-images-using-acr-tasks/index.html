<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>How to automatically purge stale images from Azure Container Registry using ACR Tasks :: my tech ramblings — A blog for writing about my techie ramblings</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Keeping your container registry free of stale or unwanted images is a task that often gets overlooked when beginning working with containers in the enterprise.
If you have a container registry in any cloud provider, like ACR (Azure Container Registry) or ECR (AWS Elastic Container Registry), and you keep pushing and pushing new images and new versions of existing images without removing the stale ones, the first thing that you&amp;rsquo;re going to notice is that your cloud bill keeps increasing because storing images is not free, but also managing the container registry will become more and more cumbersome as more and more images start to pile up."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://www.mytechramblings.com/posts/automatically-purge-acr-images-using-acr-tasks/" />





<link rel="stylesheet" href="https://www.mytechramblings.com/assets/style.css">


<link rel="stylesheet" href="https://www.mytechramblings.com/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.mytechramblings.com/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://www.mytechramblings.com/img/favicon.png">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="How to automatically purge stale images from Azure Container Registry using ACR Tasks">
  <meta name="twitter:description" content="Keeping your container registry free of stale or unwanted images is a task that often gets overlooked when beginning working with containers in the enterprise. In this post, I want to show you how you can use ACR Tasks to automate this process when working with Azure Container Registry.">



<meta property="og:url" content="https://www.mytechramblings.com/posts/automatically-purge-acr-images-using-acr-tasks/">
  <meta property="og:site_name" content="my tech ramblings">
  <meta property="og:title" content="How to automatically purge stale images from Azure Container Registry using ACR Tasks">
  <meta property="og:description" content="Keeping your container registry free of stale or unwanted images is a task that often gets overlooked when beginning working with containers in the enterprise. In this post, I want to show you how you can use ACR Tasks to automate this process when working with Azure Container Registry.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2022-12-21T13:03:19+01:00">
    <meta property="article:modified_time" content="2022-12-21T13:03:19+01:00">
    <meta property="article:tag" content="Azure">
    <meta property="article:tag" content="Containers">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Terraform">






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://www.mytechramblings.com/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">my tech ramblings</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="https://www.dotnetramblings.com">.NET News</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="https://www.dotnetramblings.com">.NET News</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://www.mytechramblings.com/posts/automatically-purge-acr-images-using-acr-tasks/">How to automatically purge stale images from Azure Container Registry using ACR Tasks</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2022-12-21
        </span>

        
          
            



          
        
      

      
      
        <span class="post-read-time">— 10 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://www.mytechramblings.com/tags/azure/">azure</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/containers/">containers</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/docker/">docker</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/terraform/">terraform</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Keeping your container registry free of stale or unwanted images is a task that often gets overlooked when beginning working with containers in the enterprise.</p>
<p>If you have a container registry in any cloud provider, like ACR (Azure Container Registry) or ECR (AWS Elastic Container Registry), and you keep pushing and pushing new images and new versions of existing images without removing the stale ones, the first thing that you&rsquo;re going to notice is that your cloud bill keeps increasing because storing images is not free, but also managing the container registry will become more and more cumbersome as more and more images start to pile up.</p>
<p>An universal solution when you want to remove old images of your container registry is to write some kind of script, which connects to the registry and removes the dated image versions. This script can be executed on demand, but in most cases you&rsquo;ll end up having a scheduled execution using a third party tool like: Azure Pipelines, Github Actions, Azure Functions, etc.</p>
<p>If you&rsquo;re using Azure Container Registry, a better alternative to purge container images is to use an <strong>ACR Task</strong>, and that&rsquo;s what I want to show you in this post.</p>
<h1 id="what-is-acr-tasks"><strong>What is ACR Tasks?</strong></h1>
<p>ACR Tasks comprises a compute execution workflow within Azure Container Registry. <br>
It can perform some container related actions, like building your application image when the source code gets updated, keep your images up-to-date and a few others functionalities.</p>
<p>A Task runs within ACR and uses an ephemeral virtual machine.</p>
<p>If you want to know more about ACR Tasks you can read it here:</p>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/container-registry/container-registry-tasks-overview">https://learn.microsoft.com/en-us/azure/container-registry/container-registry-tasks-overview</a></li>
</ul>
<p>In this post we&rsquo;re going to create an ACR Task that uses the <strong>ACR CLI</strong> to purge old images.</p>
<h1 id="azure-container-registry-cli"><strong>Azure Container Registry CLI</strong></h1>
<p>The ACR CLI allow us to interact with ACR, the currently supported commands include:</p>
<ul>
<li><strong>Tag</strong>: to view all the tags of a repository and individually untag them.</li>
<li><strong>Manifest</strong>: to view the manifest of a given repository and delete them if necessary.</li>
<li><strong>Purge</strong>: to be able to delete all tags that are older than a certain date and that match a regex specified filter.</li>
</ul>
<p>You can download the ACR CLI from its <a href="https://github.com/Azure/acr-cli">Github page</a>, and use it like any other CLI tool.</p>
<p>The ACR CLI is also integrated with the ACR Tasks, which means that you <strong>can execute any ACR CLI command within an ACR Task</strong>.</p>
<p>Here&rsquo;s a basic example of how to use the ACR CLI to list all the available tags in a repository:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ acr tag list -r acrtasksdemo --repository my-app
</span></span><span style="display:flex;"><span>Listing tags <span style="color:#66d9ef">for</span> the <span style="color:#e6db74">&#34;my-app&#34;</span> repository:
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:1.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:3.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:4.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:dev
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:prod
</span></span></code></pre></div><p>To execute an ACR Task, you can use the AZ CLI and the <code>az acr run</code> command. An ACR Task won&rsquo;t run on your local machine, <strong>it will run on an ephemeral virtual machine in Azure</strong>.</p>
<p>Here&rsquo;s the previous example I ran, but this time using an ACR Task to execute the <code>acr tag list</code> command on Azure.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ az acr run --cmd <span style="color:#e6db74">&#34;acr tag list --repository my-app&#34;</span> --registry acrtasksdemo /dev/null
</span></span><span style="display:flex;"><span>Queued a run with ID: cb2
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> an agent...
</span></span><span style="display:flex;"><span>2022/12/20 15:49:12 Alias support enabled <span style="color:#66d9ef">for</span> version &gt;<span style="color:#f92672">=</span> 1.1.0, please see https://aka.ms/acr/tasks/task-aliases <span style="color:#66d9ef">for</span> more information.
</span></span><span style="display:flex;"><span>2022/12/20 15:49:12 Creating Docker network: acb_default_network, driver: <span style="color:#e6db74">&#39;bridge&#39;</span>
</span></span><span style="display:flex;"><span>2022/12/20 15:49:12 Successfully set up Docker network: acb_default_network
</span></span><span style="display:flex;"><span>2022/12/20 15:49:12 Setting up Docker configuration...
</span></span><span style="display:flex;"><span>2022/12/20 15:49:13 Successfully set up Docker configuration
</span></span><span style="display:flex;"><span>2022/12/20 15:49:13 Logging in to registry: acrtasksdemo.azurecr.io
</span></span><span style="display:flex;"><span>2022/12/20 15:49:14 Successfully logged into acrtasksdemo.azurecr.io
</span></span><span style="display:flex;"><span>2022/12/20 15:49:14 Executing step ID: acb_step_0. Timeout<span style="color:#f92672">(</span>sec<span style="color:#f92672">)</span>: 600, Working directory: <span style="color:#e6db74">&#39;&#39;</span>, Network: <span style="color:#e6db74">&#39;acb_default_network&#39;</span>
</span></span><span style="display:flex;"><span>2022/12/20 15:49:14 Launching container with name: acb_step_0
</span></span><span style="display:flex;"><span>Listing tags <span style="color:#66d9ef">for</span> the <span style="color:#e6db74">&#34;my-app&#34;</span> repository:
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:1.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:3.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:4.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:dev
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:prod
</span></span><span style="display:flex;"><span>2022/12/20 15:49:14 Successfully executed container: acb_step_0
</span></span><span style="display:flex;"><span>2022/12/20 15:49:14 Step ID: acb_step_0 marked as successful <span style="color:#f92672">(</span>elapsed time in seconds: 0.810056<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>If we take a look in the Azure Portal, you&rsquo;ll see that an ACR Task has been executed inside our ACR.</p>
<p><img alt="acr-task-execution" src="/img/acr-task-execution.png"></p>
<h2 id="running-an-acr-task-on-schedule"><strong>Running an ACR Task on schedule</strong></h2>
<p>The previous example ran an ACR Task on-demand, but you can also run it on a regular basis using the <code>az acr task create</code> command and the <code>schedule</code> parameter.</p>
<p>The next code snippet shows the previous example I ran, but this time using an scheduled ACR Task to execute the <code>acr tag list</code> command every minute:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>az acr task create --name <span style="color:#e6db74">&#34;scheduledAcrTask&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --cmd <span style="color:#e6db74">&#34;acr tag list --repository my-app&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --schedule <span style="color:#e6db74">&#34;* * * * *&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --registry acrtasksdemo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>        --context /dev/null
</span></span></code></pre></div><p>If we go into the Azure Portal, you&rsquo;ll see that an scheduled ACR Task has been created.</p>
<p><img alt="acr-scheduled-task" src="/img/acr-scheduled-task.png"></p>
<p>And if we take a look at the recent ACR Tasks run, we&rsquo;ll see how every minute the &ldquo;scheduledAcrTask&rdquo; gets executed.</p>
<p><img alt="acr-scheduled-task-details" src="/img/acr-scheduled-task-details.png"></p>
<h1 id="using-the-purge-command"><strong>Using the purge command</strong></h1>
<p>The <code>purge</code> command is one of the available commands on the ACR CLI and it allows us to delete tags and images in a single or in multiple repositories based on:</p>
<ul>
<li>The name of the repository.</li>
<li>The name of the tags.</li>
<li>The date when the image was pushed into the repository.</li>
</ul>
<h2 id="filter-parameter"><strong>filter parameter</strong></h2>
<p>This parameter allows us to specify which tags are going to be purged based on a regular expression.</p>
<blockquote>
<p><strong>Important</strong>: The <code>filter</code> parameter only purges tags, <strong>it doesn&rsquo;t delete the images</strong> per se. To delete the tags and the images in a single command you need to use the <code>untagged</code> parameter.</p>
</blockquote>
<p>Let&rsquo;s see a few examples.</p>
<p>I have 2 repositories on my ACR with the following tags.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ acr tag list -r acrtasksdemo --repository my-app
</span></span><span style="display:flex;"><span>Listing tags <span style="color:#66d9ef">for</span> the <span style="color:#e6db74">&#34;my-app&#34;</span> repository:
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:1.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:3.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:4.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:dev
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:prod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ acr tag list -r acrtasksdemo --repository another-app
</span></span><span style="display:flex;"><span>Listing tags <span style="color:#66d9ef">for</span> the <span style="color:#e6db74">&#34;another-app&#34;</span> repository:
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app:1.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app:dev
</span></span></code></pre></div><ul>
<li>Purge all images and tags from the &ldquo;my-app&rdquo; repository, except the ones that has the &ldquo;dev&rdquo; or &ldquo;prod&rdquo; tags.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ acr purge --registry acrtasksdemo --filter <span style="color:#e6db74">&#39;my-app:^((?!prod|dev).)*$&#39;</span> --untagged --ago 0d --dry-run
</span></span><span style="display:flex;"><span>DRY RUN: The following output shows what WOULD be deleted <span style="color:#66d9ef">if</span> the purge command was executed. Nothing is deleted.
</span></span><span style="display:flex;"><span>This repository would be deleted: my-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:4.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:3.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:1.0.0
</span></span><span style="display:flex;"><span>Manifests <span style="color:#66d9ef">for</span> this repository would be deleted: my-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:4096d3149843a25b599b2b603a0cfc9983870511669092ad6df0f5dc2fc600b4
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:57a94fc99816c6aa225678b738ac40d85422e75dbb96115f1bb9b6ed77176166
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:aa81b44e52f1434cf8f4673c7db7a01601ed3d6c1b44539c868a4324e963fcdd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number of tags to be deleted: <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>Number of manifests to be deleted: <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><ul>
<li>Purge all images and tags from all repositories, except those that has the &ldquo;dev&rdquo; or &ldquo;prod&rdquo; tags.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ acr purge --registry acrtasksdemo --filter <span style="color:#e6db74">&#39;.*:^((?!prod|dev).)*$&#39;</span> --untagged --ago 0d --dry-run
</span></span><span style="display:flex;"><span>DRY RUN: The following output shows what WOULD be deleted <span style="color:#66d9ef">if</span> the purge command was executed. Nothing is deleted.
</span></span><span style="display:flex;"><span>This repository would be deleted: another-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app:1.0.0
</span></span><span style="display:flex;"><span>Manifests <span style="color:#66d9ef">for</span> this repository would be deleted: another-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app@sha256:579c1f1008733c26af5bfbd189eaa8209c344182b24ef839456e2f4d78923e58
</span></span><span style="display:flex;"><span>This repository would be deleted: my-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:4.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:3.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:1.0.0
</span></span><span style="display:flex;"><span>Manifests <span style="color:#66d9ef">for</span> this repository would be deleted: my-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:4096d3149843a25b599b2b603a0cfc9983870511669092ad6df0f5dc2fc600b4
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:57a94fc99816c6aa225678b738ac40d85422e75dbb96115f1bb9b6ed77176166
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:aa81b44e52f1434cf8f4673c7db7a01601ed3d6c1b44539c868a4324e963fcdd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number of tags to be deleted: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>Number of manifests to be deleted: <span style="color:#ae81ff">4</span>
</span></span></code></pre></div><ul>
<li>Purge all images from all repositories.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ acr purge --registry acrtasksdemo --filter <span style="color:#e6db74">&#39;.*:.*&#39;</span> --untagged --ago 0d --dry-run
</span></span><span style="display:flex;"><span>DRY RUN: The following output shows what WOULD be deleted <span style="color:#66d9ef">if</span> the purge command was executed. Nothing is deleted.
</span></span><span style="display:flex;"><span>This repository would be deleted: another-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app:dev
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app:1.0.0
</span></span><span style="display:flex;"><span>Manifests <span style="color:#66d9ef">for</span> this repository would be deleted: another-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app@sha256:579c1f1008733c26af5bfbd189eaa8209c344182b24ef839456e2f4d78923e58
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/another-app@sha256:5be2fee6cd04d4fadb78f301797ee118621ca7c8e8a251314f98a9f52380780e
</span></span><span style="display:flex;"><span>This repository would be deleted: my-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:4.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:dev
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:3.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:prod
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:1.0.0
</span></span><span style="display:flex;"><span>Manifests <span style="color:#66d9ef">for</span> this repository would be deleted: my-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:4096d3149843a25b599b2b603a0cfc9983870511669092ad6df0f5dc2fc600b4
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:57a94fc99816c6aa225678b738ac40d85422e75dbb96115f1bb9b6ed77176166
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:8aa1d6c1d510fadd745b9c007e5fd6ad6e3e15254a7476129b84255bd61d2389
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:aa81b44e52f1434cf8f4673c7db7a01601ed3d6c1b44539c868a4324e963fcdd
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:d6cd3f9f3d8aa2de3f176c047d7dcc016cdbef90e5e4c0f902b535b98573ffe5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number of tags to be deleted: <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span>Number of manifests to be deleted: <span style="color:#ae81ff">7</span>
</span></span></code></pre></div><h2 id="ago-parameter"><strong>ago parameter</strong></h2>
<p>This parameter allow us to purge all tags that are older than the specified value.</p>
<blockquote>
<p><strong>Important</strong>: The <code>ago</code> parameter only purges tags, <strong>it doesn&rsquo;t delete the images</strong> per se. To delete the tags and the images in a single command you need to use the <code>untagged</code> parameter.</p>
</blockquote>
<p>Here&rsquo;s an example:</p>
<ul>
<li>Purge all images and tags from all repositories that are older than 3 days.</li>
</ul>
<p><code>acr purge --registry acrtasksdemo --filter '.*:.*' --untagged --ago 3d --dry-run</code></p>
<p>The <code>ago</code> parameter is always required when using the <code>purge</code> command, but if you don&rsquo;t care about the date you can set it to <code>0d</code>. <br>
For example, the <code>acr purge --registry acrtasksdemo --filter 'my-app:.*' --untagged --ago 0d</code> command, purges all images and tags from the &ldquo;my-app&rdquo; repository without taking into account the date they were pushed into the registry.</p>
<h2 id="keep-parameter"><strong>keep parameter</strong></h2>
<p>This parameter allow us to keep the latest number of tags.</p>
<blockquote>
<p><strong>Important</strong>: The <code>keep</code> parameter only purges tags, <strong>it doesn&rsquo;t delete the images</strong> per se. To delete the tags and the images in a single command you need to use the <code>untagged</code> parameter.</p>
</blockquote>
<p>The following example will keep the latest 3 tags and images of &ldquo;my-app&rdquo; repository, and remove the remaining ones.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>acr purge --registry acrtasksdemo --filter <span style="color:#e6db74">&#39;my-app:.*&#39;</span> --keep <span style="color:#ae81ff">3</span> --untagged --ago 0d --dry-run
</span></span><span style="display:flex;"><span>DRY RUN: The following output shows what WOULD be deleted <span style="color:#66d9ef">if</span> the purge command was executed. Nothing is deleted.
</span></span><span style="display:flex;"><span>This repository would be deleted: my-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:prod
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:2.0.0
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app:1.0.0
</span></span><span style="display:flex;"><span>Manifests <span style="color:#66d9ef">for</span> this repository would be deleted: my-app
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:57a94fc99816c6aa225678b738ac40d85422e75dbb96115f1bb9b6ed77176166
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:8aa1d6c1d510fadd745b9c007e5fd6ad6e3e15254a7476129b84255bd61d2389
</span></span><span style="display:flex;"><span>acrtasksdemo.azurecr.io/my-app@sha256:aa81b44e52f1434cf8f4673c7db7a01601ed3d6c1b44539c868a4324e963fcdd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Number of tags to be deleted: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>Number of manifests to be deleted: <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><h2 id="dry-run-parameter"><strong>dry-run parameter</strong></h2>
<p>To know which tags and images would be deleted the <code>dry-run</code> flag can be set, nothing will be deleted and the output would be the same as if the purge command was executed normally.</p>
<h1 id="create-a-scheduled-acr-task-that-purges-stale-images-from-an-acr"><strong>Create a scheduled ACR Task that purges stale images from an ACR</strong></h1>
<p>Now that we know how the <code>purge</code> command works, it is time to create an scheduled ACR Task that purges the stale images once every week.</p>
<p>Obviously, every one will have different requirements when purging images from an ACR repository, mainly because there are dozens of viable tag strategies you can follow when working with containers.<br>
But, for this post I&rsquo;m going to create the following ACR Task:</p>
<ul>
<li>It will be an scheduled ACR Task that runs once every week.</li>
<li>It will purge all the images that are older than 30 days from all the existing repositories, except the images with the &ldquo;dev&rdquo; or &ldquo;prod&rdquo; tag assigned.</li>
</ul>
<p>Let&rsquo;s build the command we need:</p>
<ul>
<li>To purge all tags from all the existing repositories and keep only the &ldquo;dev&rdquo; and &ldquo;prod&rdquo; tag, we need to specify the following value for the <code>filter</code> parameter <code>.*:^((?!prod|dev).)*$</code>
<ul>
<li>With the <code>.*</code> regular expression we&rsquo;re targeting all the repositories available in the ACR.</li>
<li>With the <code>^((?!prod|dev).)*$</code> regular expression we&rsquo;re targeting all the tags except &ldquo;prod&rdquo; or &ldquo;dev&rdquo;.</li>
</ul>
</li>
<li>To purge all tags older than 30days, we need to set the <code>ago</code> parameter to: <code>--ago 30d</code></li>
<li>The <code>filter</code> and <code>ago</code> parameter doesn&rsquo;t delete the manifest per se, it only purges the tags. To remove the images we have to use the <code>untagged</code> attribute.</li>
<li>To run the ACR Task once every week we&rsquo;re going to use the <code>schedule</code> attribute alongside a CRON value. For example, this one: <code>55 18 * * Tue</code>, which means that the ACR Task will run every Tuesday at 18:55 UTC Time.</li>
</ul>
<p>Here&rsquo;s how the end result looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>  az acr task create <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --name <span style="color:#e6db74">&#34;scheduledAcrPurgeTask&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --cmd <span style="color:#e6db74">&#34;acr purge --filter &#39;.*:^((?!prod|dev).)*</span>$<span style="color:#e6db74">&#39; --untagged --ago 30d&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --schedule <span style="color:#e6db74">&#34;55 18 * * Tue&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --registry acrtasksdemo <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>      --context /dev/null
</span></span></code></pre></div><p>If we take a look at the Azure portal after the ACR Task ran for the first time, we will see how it has deleted every image and tag older than 30 days except the ones with the &ldquo;prod&rdquo; or &ldquo;dev&rdquo; tags associated.</p>
<p><img alt="acr-purge-scheduled-dev-prod-task" src="/img/acr-purge-scheduled-dev-prod-task.png"></p>
<p>If we take a closer look at one of the repositories, the only remaining images are the ones with the &ldquo;prod&rdquo; or &ldquo;dev&rdquo; tags on them.</p>
<p><img alt="acr-purge-scheduled-dev-prod-task-repository" src="/img/acr-purge-scheduled-dev-prod-task-repository.png"></p>
<h1 id="terraform-implementation"><strong>Terraform implementation</strong></h1>
<p>As a bonus section, let me show you how you can create the same scheduled ACR Task using Terraform and the AzureRM provider.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">resource</span> <span style="color:#e6db74">&#34;azurerm_container_registry_task&#34;</span> <span style="color:#e6db74">&#34;acr_purge_task&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">name</span>                  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;scheduledAcrPurgeTask&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">container_registry_id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">azurerm_container_registry</span>.<span style="color:#a6e22e">acr</span>.<span style="color:#a6e22e">id</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">platform</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">os</span>           <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Linux&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">architecture</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;amd64&#34;</span> 
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">encoded_step</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">task_content</span> <span style="color:#f92672">=</span> <span style="color:#f92672">&lt;&lt;</span><span style="color:#a6e22e">EOF</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">version</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">v1</span>.<span style="color:#ae81ff">1.0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">steps</span><span style="color:#f92672">:</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">-</span> <span style="color:#a6e22e">cmd</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">acr</span> <span style="color:#a6e22e">purge</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">filter</span> <span style="color:#e6db74">&#39;.*:^((?!prod|dev).)*$&#39;</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">untagged</span> <span style="color:#f92672">--</span><span style="color:#a6e22e">ago</span> <span style="color:#ae81ff">30</span><span style="color:#a6e22e">d</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">disableWorkingDirectoryOverride</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">timeout</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">3600</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">EOF</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">agent_setting</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">cpu</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">timer_trigger</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">name</span>     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;t1&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">schedule</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;55 18 * * Tue&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">enabled</span>  <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://www.mytechramblings.com/posts/modernize-wcf-legacy-app-using-corewcf/">
                  <span class="button__icon">←</span>
                  <span class="button__text">How to modernize a legacy .NET Framework WCF app using CoreWCF and .NET 7</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://www.mytechramblings.com/posts/trying-out-the-built-in-container-support-for-the-dotnet-7-sdk/">
                  <span class="button__text">Trying out the built-in container support for the .NET SDK</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2024 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://www.mytechramblings.com/assets/main.js"></script>
<script src="https://www.mytechramblings.com/assets/prism.js"></script>
<script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
<script>
  kofiWidgetOverlay.draw('carlospons', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Donate',
    'floating-chat.donateButton.background-color': '#ff5f5f',
    'floating-chat.donateButton.text-color': '#fff'
  });
</script>

      
    </div>

    
      
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-FLNJKRG5D1"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-FLNJKRG5D1');
        }
      </script>
    
  


    
  </body>
</html>
