<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>How to restore nuget packages from an Azure DevOps Private Feed when building a Docker image :: my tech ramblings — A blog for writing about my techie ramblings</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Let&amp;rsquo;s go for a quick post this time.
Imagine you&amp;rsquo;re trying to create a Docker image from an application and it is using some custom nugets. Those custom nugets are hosted in your private Azure DevOps Feed. And when you try to build the image you get one of the following errors:
/src/MyConsoleApplication.csproj : error NU1101: Unable to find package MyOwn.EmailService. No packages exist with this id in source(s): nuget.org Failed to restore /src/MyConsoleApplication."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://www.mytechramblings.com/posts/how-to-use-a-private-nuget-feed-with-docker/" />





<link rel="stylesheet" href="https://www.mytechramblings.com/assets/style.css">


<link rel="stylesheet" href="https://www.mytechramblings.com/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.mytechramblings.com/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://www.mytechramblings.com/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to restore nuget packages from an Azure DevOps Private Feed when building a Docker image"/>
<meta name="twitter:description" content="Let&rsquo;s go for a quick post this time.
Imagine you&rsquo;re trying to create a Docker image from an application and it is using some custom nugets. Those custom nugets are hosted in your private Azure DevOps Feed. And when you try to build the image you get one of the following errors:
/src/MyConsoleApplication.csproj : error NU1101: Unable to find package MyOwn.EmailService. No packages exist with this id in source(s): nuget.org Failed to restore /src/MyConsoleApplication."/>



<meta property="og:title" content="How to restore nuget packages from an Azure DevOps Private Feed when building a Docker image" />
<meta property="og:description" content="Let&rsquo;s go for a quick post this time.
Imagine you&rsquo;re trying to create a Docker image from an application and it is using some custom nugets. Those custom nugets are hosted in your private Azure DevOps Feed. And when you try to build the image you get one of the following errors:
/src/MyConsoleApplication.csproj : error NU1101: Unable to find package MyOwn.EmailService. No packages exist with this id in source(s): nuget.org Failed to restore /src/MyConsoleApplication." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.mytechramblings.com/posts/how-to-use-a-private-nuget-feed-with-docker/" />
<meta property="article:published_time" content="2020-07-14T19:12:41+02:00" />
<meta property="article:modified_time" content="2020-07-14T19:12:41+02:00" /><meta property="og:site_name" content="my tech ramblings" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://www.mytechramblings.com/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">my tech ramblings</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://www.mytechramblings.com/posts/how-to-use-a-private-nuget-feed-with-docker/">How to restore nuget packages from an Azure DevOps Private Feed when building a Docker image</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-07-14
        </span>

        
          
            



          
        
      

      
      
        <span class="post-read-time">— 5 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://www.mytechramblings.com/tags/csharp/">csharp</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/docker/">docker</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/nuget/">nuget</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/containers/">containers</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/windows/">windows</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>Let&rsquo;s go for a quick post this time.</p>
<p>Imagine you&rsquo;re trying to create a Docker image from an application and it is using some custom nugets. Those custom nugets are hosted in your private Azure DevOps Feed.
And when you try to build the image you get one of the following errors:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/src/MyConsoleApplication.csproj : error NU1101: Unable to find package MyOwn.EmailService. No packages exist with this id in source<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>: nuget.org
  Failed to restore /src/MyConsoleApplication.csproj <span style="color:#f92672">(</span>in 2.37 sec<span style="color:#f92672">)</span>.
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">C:<span style="color:#ae81ff">\P</span>rogram Files<span style="color:#ae81ff">\d</span>otnet<span style="color:#ae81ff">\s</span>dk<span style="color:#ae81ff">\3</span>.1.301<span style="color:#ae81ff">\N</span>uGet.targets<span style="color:#f92672">(</span>128,5<span style="color:#f92672">)</span>: error : Unable to load the service index <span style="color:#66d9ef">for</span> source https://pkgs.dev.azure.com/cpn/_packaging/my-very-private-feed/nuget/v3/index.json. <span style="color:#f92672">[</span>C:<span style="color:#ae81ff">\s</span>rc<span style="color:#ae81ff">\M</span>yConsoleApplication.csproj<span style="color:#f92672">]</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">C:<span style="color:#ae81ff">\P</span>rogram Files<span style="color:#ae81ff">\d</span>otnet<span style="color:#ae81ff">\s</span>dk<span style="color:#ae81ff">\3</span>.1.301<span style="color:#ae81ff">\N</span>uGet.targets<span style="color:#f92672">(</span>128,5<span style="color:#f92672">)</span>: error :   Response status code does not indicate success: <span style="color:#ae81ff">401</span> <span style="color:#f92672">(</span>Unauthorized<span style="color:#f92672">)</span>. <span style="color:#f92672">[</span>C:<span style="color:#ae81ff">\s</span>rc<span style="color:#ae81ff">\M</span>yConsoleApplication.csproj<span style="color:#f92672">]</span>
</code></pre></div><p>That&rsquo;s a pretty common pain point when trying to create a Docker image that uses a private Azure DevOps Feed.</p>
<p>To solve this problem there are two possible solutions:</p>
<ul>
<li>Place a NuGet.Config file inside your application and use it when creating the image.</li>
<li>Use the Azure Artifacts Credentials Provider</li>
</ul>
<p>The first option is the older one and used to be the way to do it.<br>
The second one is the most recent one and in my opinion a better way to do it.</p>
<p>I&rsquo;m going to show you how you can fix it using both Linux and Windows Containers. But first I&rsquo;m going to set everything up on the Azure Devops end.</p>
<p>I did the following steps on my Azure DevOps account:</p>
<p>1- Create a private Azure DevOps Feed named <em><strong>&ldquo;my-very-private-feed&rdquo;</strong></em></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span style="color:#f92672">&lt;configuration&gt;</span>
  <span style="color:#f92672">&lt;packageSources&gt;</span>
    <span style="color:#f92672">&lt;clear</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;my-very-private-feed&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;https://pkgs.dev.azure.com/cpn/_packaging/my-very-private-feed/nuget/v3/index.json&#34;</span> <span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/packageSources&gt;</span>
<span style="color:#f92672">&lt;/configuration&gt;</span>

</code></pre></div><p>2- Push a custom Nuget named <em><strong>&ldquo;MyOwn.EmailService&rdquo;</strong></em> into my the Azure DevOps feed.</p>
<p>3- Create a .NETCore 3.1 console app that uses the <em><strong>&ldquo;MyOwn.EmailService&rdquo;</strong></em> nuget</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">
<span style="color:#f92672">&lt;Project</span> <span style="color:#a6e22e">Sdk=</span><span style="color:#e6db74">&#34;Microsoft.NET.Sdk&#34;</span><span style="color:#f92672">&gt;</span>

  <span style="color:#f92672">&lt;PropertyGroup&gt;</span>
    <span style="color:#f92672">&lt;OutputType&gt;</span>Exe<span style="color:#f92672">&lt;/OutputType&gt;</span>
    <span style="color:#f92672">&lt;TargetFramework&gt;</span>netcoreapp3.1<span style="color:#f92672">&lt;/TargetFramework&gt;</span>
  <span style="color:#f92672">&lt;/PropertyGroup&gt;</span>

  <span style="color:#f92672">&lt;ItemGroup&gt;</span>
    <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;MyOwn.EmailService&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.0.0&#34;</span> <span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/ItemGroup&gt;</span>

<span style="color:#f92672">&lt;/Project&gt;</span>

</code></pre></div><p>4 - Create a DockerFile for the app</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/runtime:3.1-buster-slim AS base</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/sdk:3.1-buster AS build</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet restore <span style="color:#e6db74">&#34;./MyConsoleApplication.csproj&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> &#34;/src/.&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet build <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> build AS publish</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet publish <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/publish<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS final</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>publish /app/publish .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;MyConsoleApplication.dll&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>And when everything is set it up if I try to built the image it fails miserably with a 401 error&hellip; <br>
Let&rsquo;s see how to fix it.</p>
<h2 id="scenario-1--using-a-nugetconfig">Scenario 1 : Using a NuGet.Config</h2>
<hr>
<p>Create a NuGet.Config and place it within the app.<br>
You also need to create a PAT <em>(Personal Access Token)</em> to authenticate against the private feed.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
<span style="color:#f92672">&lt;configuration&gt;</span>
  <span style="color:#f92672">&lt;packageSources&gt;</span>
    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;nuget.org&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;https://api.nuget.org/v3/index.json&#34;</span> <span style="color:#a6e22e">protocolVersion=</span><span style="color:#e6db74">&#34;3&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;my-very-private-feed&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;https://pkgs.dev.azure.com/cpn/_packaging/my-very-private-feed/nuget/v3/index.json&#34;</span> <span style="color:#f92672">/&gt;</span>
  <span style="color:#f92672">&lt;/packageSources&gt;</span>
  <span style="color:#f92672">&lt;packageSourceCredentials&gt;</span>
    <span style="color:#f92672">&lt;my-very-private-feed&gt;</span>
      <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;Username&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;my-user@outlook.com&#34;</span> <span style="color:#f92672">/&gt;</span>
      <span style="color:#f92672">&lt;add</span> <span style="color:#a6e22e">key=</span><span style="color:#e6db74">&#34;ClearTextPassword&#34;</span> <span style="color:#a6e22e">value=</span><span style="color:#e6db74">&#34;put-your-pat-here&#34;</span> <span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;/my-very-private-feed&gt;</span>
  <span style="color:#f92672">&lt;/packageSourceCredentials&gt;</span>
<span style="color:#f92672">&lt;/configuration&gt;</span>

</code></pre></div><p>Change the Dockerfile to use the NuGet.Config file when trying to restore the nugets:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/runtime:3.1-buster-slim AS base</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/sdk:3.1-buster AS build</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> NuGet.Config ./<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet restore --configfile NuGet.Config <span style="color:#e6db74">&#34;./MyConsoleApplication.csproj&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> &#34;/src/.&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet build <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> build AS publish</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet publish <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/publish<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS final</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>publish /app/publish .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;MyConsoleApplication.dll&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>And it everything works flawlessly.</p>
<h2 id="scenario-2-using-the-artifacts-credential-provider">Scenario 2: Using the Artifacts Credential Provider</h2>
<hr>
<p>The Azure Artifacts Credentials provider is an executable that eases the acquisition of credentials needed to restore NuGet packages.<br>
You can read more about it <a href="https://github.com/microsoft/artifacts-credprovider">here</a></p>
<p>In that scenario we are going to use a bash script to install the credential provider, and also we are going to specify some environment variables for the provider to work.</p>
<p>We need the following variables:</p>
<ul>
<li>NUGET_CREDENTIALPROVIDER_SESSIONTOKENCACHE_ENABLED: Controls whether or not the session token is saved to disk. If false, the Credential Provider will prompt for auth every time.</li>
<li>VSS_NUGET_EXTERNAL_FEED_ENDPOINTS: A JSON that contains an array of service endpoints, usernames and access tokens.
The provider authenticates against all the providers found inside the array, so if you want you can have multiple private feeds.</li>
</ul>
<p>Also In the <em>&ldquo;dotnet restore&rdquo;</em> step we need to specify our private feed. If we don&rsquo;t specify it  the credential provider will try to restore the nugets using only the default feed.</p>
<p>The Dockerfile looks like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/runtime:3.1-buster-slim AS base</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/sdk:3.1-buster AS build</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">ENV</span> NUGET_CREDENTIALPROVIDER_SESSIONTOKENCACHE_ENABLED true<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> VSS_NUGET_EXTERNAL_FEED_ENDPOINTS <span style="color:#f92672">{</span><span style="color:#ae81ff">\&#34;</span>endpointCredentials<span style="color:#ae81ff">\&#34;</span>: <span style="color:#f92672">[{</span><span style="color:#ae81ff">\&#34;</span>endpoint<span style="color:#ae81ff">\&#34;</span>:<span style="color:#ae81ff">\&#34;</span>https://pkgs.dev.azure.com/cpn/_packaging/my-very-private-feed/nuget/v3/index.json<span style="color:#ae81ff">\&#34;</span>, <span style="color:#ae81ff">\&#34;</span>username<span style="color:#ae81ff">\&#34;</span>:<span style="color:#ae81ff">\&#34;</span>my-user@outlook.com<span style="color:#ae81ff">\&#34;</span>, <span style="color:#ae81ff">\&#34;</span>password<span style="color:#ae81ff">\&#34;</span>:<span style="color:#ae81ff">\&#34;</span>put-your-pat-here<span style="color:#ae81ff">\&#34;</span><span style="color:#f92672">}]}</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> wget -qO- https://raw.githubusercontent.com/Microsoft/artifacts-credprovider/master/helpers/installcredprovider.sh | bash<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet restore <span style="color:#e6db74">&#34;./MyConsoleApplication.csproj&#34;</span> -s <span style="color:#e6db74">&#34;https://pkgs.dev.azure.com/cpn/_packaging/my-very-private-feed/nuget/v3/index.json&#34;</span> -s <span style="color:#e6db74">&#34;https://api.nuget.org/v3/index.json&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> &#34;/src/.&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet build <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span>  -c Release -o /app/build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> build AS publish</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet publish <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/publish<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS final</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>publish /app/publish .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;MyConsoleApplication.dll&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><h2 id="windows-containers">Windows Containers</h2>
<hr>
<p>And what about the &ldquo;long forgotten&rdquo; <strong>Windows Containers?</strong><br>
Let&rsquo;s try to replicate the same scenarios but these time using Windows Containers.</p>
<h3 id="scenario-1--using-the-nugetconfig-with-a-nanoserver-image">Scenario 1 : Using the Nuget.Config with a nanoserver image</h3>
<hr>
<p>The only difference with the Linux scenario is that I&rsquo;m using a windows nanoserver image</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/runtime:3.1-nanoserver-1903 AS base</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/sdk:3.1-nanoserver-1903 AS build</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> NuGet.Config ./<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet restore --configfile NuGet.Config <span style="color:#e6db74">&#34;./MyConsoleApplication.csproj&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> &#34;/src/.&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet build <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> build AS publish</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet publish <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/publish<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS final</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>publish /app/publish .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;MyConsoleApplication.dll&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>It works without any hitch.</p>
<h3 id="scenario-2-using-the-artifacts-credential-provider-1">Scenario 2: Using the Artifacts Credential Provider</h3>
<p>That scenario is the real pain!</p>
<p>We are running on windows containers, so we cannot use the bash script to install the provider, instead of using the bash script we are going to use another script written in Powershell.<br>
That&rsquo;s not a problem at all because the nanoserver image comes with Powershell Core already installed.</p>
<p>The real problem is that the credential provider installer doesn&rsquo;t play nice with the nanoserver image. The solution is to install the credentials provider in a <strong>windows server core</strong> image and copy the folder where the credential provider is installed into the nanoserver image.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># escape=`</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Install the cred provider in a separate stage based on Windows Server Core</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># due to https://github.com/microsoft/artifacts-credprovider/issues/201</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/powershell as credproviderinstaller</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">SHELL</span> [<span style="color:#e6db74">&#34;pwsh&#34;</span>, <span style="color:#e6db74">&#34;-Command&#34;</span>, <span style="color:#e6db74">&#34;$ErrorActionPreference = &#39;Stop&#39;; $ProgressPreference = &#39;SilentlyContinue&#39;;&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> Invoke-WebRequest https://raw.githubusercontent.com/microsoft/artifacts-credprovider/master/helpers/installcredprovider.ps1 -OutFile installcredprovider.ps1; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    .<span style="color:#ae81ff">\i</span>nstallcredprovider.ps1; <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    del installcredprovider.ps1<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/sdk:3.1-nanoserver-1903 AS build</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> DOTNET_SYSTEM_NET_HTTP_USESOCKETSHTTPHANDLER<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">ENV</span> NUGET_CREDENTIALPROVIDER_SESSIONTOKENCACHE_ENABLED true<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> VSS_NUGET_EXTERNAL_FEED_ENDPOINTS <span style="color:#e6db74">`</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    <span style="color:#e6db74">&#34;{`&#34;</span>endpointCredentials<span style="color:#e6db74">`</span><span style="color:#e6db74">&#34;: [{`&#34;</span>endpoint<span style="color:#e6db74">`</span><span style="color:#e6db74">&#34;:`&#34;</span>https://pkgs.dev.azure.com/cpn/_packaging/my-very-private-feed/nuget/v3/index.json<span style="color:#e6db74">`</span><span style="color:#e6db74">&#34;, `&#34;</span>username<span style="color:#e6db74">`</span><span style="color:#e6db74">&#34;:`&#34;</span>myUser@outlook.com<span style="color:#e6db74">`</span><span style="color:#e6db74">&#34;, `&#34;</span>password<span style="color:#e6db74">`</span><span style="color:#e6db74">&#34;:`&#34;</span>putYourPatHere<span style="color:#e6db74">`</span><span style="color:#e6db74">&#34;}]}&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Copy cred provider from installer stage</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>credproviderinstaller C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\C</span>ontainerAdministrator<span style="color:#ae81ff">\.</span>nuget<span style="color:#ae81ff">\p</span>lugins C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\C</span>ontainerUser<span style="color:#ae81ff">\.</span>nuget<span style="color:#ae81ff">\p</span>lugins<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">]</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet restore <span style="color:#e6db74">&#34;./MyConsoleApplication.csproj&#34;</span> -s <span style="color:#e6db74">&#34;https://pkgs.dev.azure.com/cpn/_packaging/my-very-private-feed/nuget/v3/index.json&#34;</span> -s <span style="color:#e6db74">&#34;https://api.nuget.org/v3/index.json&#34;</span> <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> &#34;/src/.&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet build <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/build<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> build AS publish</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet publish <span style="color:#e6db74">&#34;MyConsoleApplication.csproj&#34;</span> -c Release -o /app/publish<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> mcr.microsoft.com/dotnet/core/runtime:3.1-nanoserver-1903 AS base</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS final</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>publish /app/publish .<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;MyConsoleApplication.dll&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>At the end of the day, it doesn&rsquo;t matter if you&rsquo;re working with windows or linux containers you can use both solutions indiscriminately.<br>
Using the credentials provider solution with Windows container is more painful because of these weird bug, but I&rsquo;m pretty confident that Microsoft is going to fix it in a near future.<br>
I used during many years the NuGet.Config solution but nowadays I prefer to use the Credential Provider because it one less file to manage in my repository.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://www.mytechramblings.com/posts/automate-azure-ad-app-registration-using-terraform/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Trying to automate Azure Active Directory App Registration process using Terraform</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://www.mytechramblings.com/posts/how-to-add-healthchecks-to-wcf-apps/">
                  <span class="button__text">Why and how you should add a healthcheck endpoint to your Wcf legacy applications</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://www.mytechramblings.com/assets/main.js"></script>
<script src="https://www.mytechramblings.com/assets/prism.js"></script>

      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-170300931-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    
  </body>
</html>
