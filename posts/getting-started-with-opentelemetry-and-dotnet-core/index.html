<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Getting started with OpenTelemetry and distributed tracing in .NET :: my tech ramblings — A blog for writing about my techie ramblings</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Just show me the code
As always, if you don’t care about the post I have upload the source code on my Github
This post was written over a year and a half ago, and since then, there have been several updates to the OpenTelemetry .NET SDK. Additionally, a new version of the .NET framework has been released. It&amp;rsquo;s time to update this post to reflect the current state of OpenTelemetry."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://www.mytechramblings.com/posts/getting-started-with-opentelemetry-and-dotnet-core/" />





<link rel="stylesheet" href="https://www.mytechramblings.com/assets/style.css">


<link rel="stylesheet" href="https://www.mytechramblings.com/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.mytechramblings.com/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://www.mytechramblings.com/img/favicon.png">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Getting started with OpenTelemetry and distributed tracing in .NET">
  <meta name="twitter:description" content="OpenTelemetry is a collection of APIs, SDKs, tools, and integrations designed for the creation and management of telemetry data, including traces, metrics, and logs. In today&#39;s post, I&#39;m going to demonstrate how you can begin using OpenTelemetry (OTEL) and distributed tracing with .NET.">



<meta property="og:url" content="https://www.mytechramblings.com/posts/getting-started-with-opentelemetry-and-dotnet-core/">
  <meta property="og:site_name" content="my tech ramblings">
  <meta property="og:title" content="Getting started with OpenTelemetry and distributed tracing in .NET">
  <meta property="og:description" content="OpenTelemetry is a collection of APIs, SDKs, tools, and integrations designed for the creation and management of telemetry data, including traces, metrics, and logs. In today&#39;s post, I&#39;m going to demonstrate how you can begin using OpenTelemetry (OTEL) and distributed tracing with .NET.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-16T09:30:51+02:00">
    <meta property="article:modified_time" content="2024-04-16T09:30:51+02:00">
    <meta property="article:tag" content="Opentelemetry">
    <meta property="article:tag" content="Tracing">
    <meta property="article:tag" content="Jaeger">
    <meta property="article:tag" content="Dotnet">
    <meta property="article:tag" content="Csharp">






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://www.mytechramblings.com/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">my tech ramblings</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="https://www.dotnetramblings.com">.NET News</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="https://www.dotnetramblings.com">.NET News</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://www.mytechramblings.com/posts/getting-started-with-opentelemetry-and-dotnet-core/">Getting started with OpenTelemetry and distributed tracing in .NET</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2024-04-16
        </span>

        
          
            



          
        
      

      
      
        <span class="post-read-time">— 15 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://www.mytechramblings.com/tags/opentelemetry/">opentelemetry</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/tracing/">tracing</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/jaeger/">jaeger</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/dotnet/">dotnet</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/csharp/">csharp</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <blockquote>
<p><strong>Just show me the code</strong><br>
As always, if you don’t care about the post I have upload the source code on my <a href="https://github.com/karlospn/opentelemetry-tracing-demo">Github</a></p>
</blockquote>
<p>This post was written over a year and a half ago, and since then, there have been several updates to the OpenTelemetry .NET SDK. Additionally, a new version of the .NET framework has been released. It&rsquo;s time to update this post to reflect the current state of OpenTelemetry.</p>
<p>OpenTelemetry is a collection of APIs, SDKs, tools, and integrations designed for the creation and management of telemetry data, such as traces, metrics, and logs. This post will focus exclusively on tracing.
From my perspective, there are at least <strong>four main concepts</strong> about tracing and OpenTelemetry that you need to understand.</p>
<h1 id="span-and-activities"><strong>Span and Activities</strong></h1>
<p>A span is the building block that forms a trace, it has a unique identifier and represents a piece of the workflow in the distributed system.<br>
Multiple spans are pieced together to create a trace. Traces are often viewed as a &ldquo;tree&rdquo; of spans that reflects the time that each span started and completed.</p>
<p>In .NET a span is represented by an <strong>Activity</strong>.</p>
<p>The OpenTelemetry client for dotnet is reusing the existing Activity and associated classes to represent the OpenTelemetry Span. <br>
This means that users can instrument their applications/libraries to emit OpenTelemetry compatible traces by using just the .NET Runtime.</p>
<p>To create a Span in .NET we must first create a new activity:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> ActivitySource Activity = <span style="color:#66d9ef">new</span>(nameof(RabbitRepository));
</span></span></code></pre></div><p>And then call <em>&ldquo;StartActivity&rdquo;</em> to begin recording, everything that happens inside the using block will be recorded into that Span.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> activity = Activity.StartActivity(<span style="color:#e6db74">&#34;Process Message&#34;</span>, ActivityKind.Consumer, parentContext.ActivityContext)){}
</span></span></code></pre></div><h1 id="propagators"><strong>Propagators</strong></h1>
<p>A propagator allows us to extract and inject context across process boundaries.</p>
<p>This is typically required if you are not using any of the .NET communication libraries which has instrumentations already available which does the propagation (eg: HttpClient). <br>
In such cases, context extraction and propagation is the responsibility of the library itself.</p>
<p>To create a propagator in .NET we must first create a TextMapPropagator</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> TextMapPropagator Propagator = <span style="color:#66d9ef">new</span> TraceContextPropagator();
</span></span></code></pre></div><p>Then use the Inject and Extract methods for inter-process trace propagation.</p>
<p>The <em>&ldquo;Inject&rdquo;</em> method injects the Activity into a carrier. For example, into the headers of an HTTP request.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Propagator.Inject(<span style="color:#66d9ef">new</span> PropagationContext(activity.Context, Baggage.Current), props, InjectContextIntoHeader);
</span></span></code></pre></div><p>And the <em>&ldquo;Extract&rdquo;</em> method extracts the value from an incoming request. For example, from the headers of an HTTP request.</p>
<p>If a value can not be parsed from the carrier, for a cross-cutting concern, the implementation should not throw an exception and should not store a new value in the Context, in order to preserve any previously existing valid value.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span> <span style="color:#66d9ef">var</span> parentContext = Propagator.Extract(<span style="color:#66d9ef">default</span>, ea.BasicProperties, ExtractTraceContextFromBasicProperties);
</span></span></code></pre></div><h1 id="exporters"><strong>Exporters</strong></h1>
<p>Let&rsquo;s be honest, emitting metrics is somewhat pointless if you don&rsquo;t have a backend capable of aggregating these metrics and presenting them in a user-friendly manner.</p>
<p>There are two methods for exporting data on OpenTelemetry:</p>
<ul>
<li>Utilizing the OpenTelemetry Collector.</li>
<li>Directly exporting the data into a backend (such as Prometheus, Jaeger, Zipkin, Elastic APM, Azure Monitor, etc).</li>
</ul>
<h2 id="using-the-opentelemetry-collector"><strong>Using the OpenTelemetry Collector</strong></h2>
<p>The OpenTelemetry Collector is a standalone process designed to receive, process and export telemetry data.</p>
<p>It removes the need to run, operate and maintain multiple agents/collectors in order to support open-source telemetry data formats (e.g. Jaeger, Prometheus, Zipkin, etc.) sending to multiple open-source or commercial back-ends.</p>
<p>It eases the integration with your apps because you only need to export your data to a single endpoint, the collector endpoint, using the OTLP protocol.</p>
<p><img alt="otel-metrics-exporter-otel-collector" src="/img/otel-metrics-exporter-otel-collector.png"></p>
<h2 id="exporting-the-data-directly-into-a-backend"><strong>Exporting the data directly into a backend</strong></h2>
<p>You can export traces, metrics and logs directly to a backend using the <code>OpenTelemetry.Exporter.*</code> NuGet packages.</p>
<p><img alt="otel-metrics-exporter-backend" src="/img/otel-metrics-exporter-backend.png"></p>
<blockquote>
<p>In this post, we&rsquo;re going to export traces directly to Jaeger using the <code>OpenTelemetry.Exporter.OpenTelemetryProtocol</code> NuGet package.</p>
</blockquote>
<h1 id="attributes"><strong>Attributes</strong></h1>
<p>Attributes are key:value pairs that provide additional information to a trace.</p>
<p>In .NET those are called Tags. We can add an attribute into an Activity like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>  activity?.SetTag(<span style="color:#e6db74">&#34;messaging.system&#34;</span>, <span style="color:#e6db74">&#34;rabbitmq&#34;</span>);
</span></span><span style="display:flex;"><span>  activity?.SetTag(<span style="color:#e6db74">&#34;messaging.destination_kind&#34;</span>, <span style="color:#e6db74">&#34;queue&#34;</span>);
</span></span><span style="display:flex;"><span>  activity?.SetTag(<span style="color:#e6db74">&#34;messaging.rabbitmq.queue&#34;</span>, <span style="color:#e6db74">&#34;sample&#34;</span>);
</span></span></code></pre></div><hr>
<hr>
<p>I&rsquo;m going to stop discussing OpenTelemetry theory because I could end up writing an entire post about it. <br>
And to be honest, I would essentially be paraphrasing the official documentation. So, instead of that, I&rsquo;ll direct you to the official documentation: <a href="https://opentelemetry.io/docs/concepts/">https://opentelemetry.io/docs/concepts/</a></p>
<p>After a brief discussion on OpenTelemetry, let&rsquo;s redirect our attention to the primary objective of this post: <strong>To offer a practical example of how to begin using OpenTelemetry when you have a series of .NET services interacting with each other.</strong></p>
<h1 id="demo"><strong>Demo</strong></h1>
<p>I have previously constructed four applications. These applications do not execute any business logic operations, as that&rsquo;s not the focus here. <br>
The critical aspect is that all the applications communicate with each other and also interact with other external services such as Redis, MSSQL, or RabbitMQ.</p>
<p>Here&rsquo;s the diagram:</p>
<p><img alt="otel-diagram" src="/img/otel-components-diagram.png"></p>
<ul>
<li>
<p><strong>App1.WebApi</strong> is a <strong>.NET 8 API</strong> with 2 endpoints.</p>
<ul>
<li>The <strong>/http</strong> endpoint makes an HTTP request to the App2 <em>&quot;/dummy&quot;</em> endpoint.</li>
<li>The <strong>/publish-message</strong> endpoint queues a message into a Rabbit queue named <em>&ldquo;sample&rdquo;</em>.</li>
</ul>
</li>
<li>
<p><strong>App2.RabbitConsumer.Console</strong> is a <strong>.NET 8 Console</strong> application.</p>
<ul>
<li>It dequeues messages from the Rabbit <em>&ldquo;sample&rdquo;</em> queue and makes an HTTP request to the <strong>App3</strong> <em>&quot;/sql-to-event&quot;</em> endpoint with the content of the message.</li>
</ul>
</li>
<li>
<p><strong>App3.WebApi</strong> is a <strong>.NET 8 Minimal API</strong> with 2 endpoints</p>
<ul>
<li>The <strong>/dummy</strong> endpoint returns a fixed <em>&ldquo;Ok&rdquo;</em> response.</li>
<li>The <strong>/sql-to-event</strong> endpoint receives a message via HTTP POST, stores it in a MSSQL Server, and afterwards publishes the message as an event into a RabbitMq queue named <em>&ldquo;sample_2&rdquo;</em>.</li>
</ul>
</li>
<li>
<p><strong>App4.RabbitConsumer.HostedService</strong> is a <strong>.NET 8 Worker Service</strong>.</p>
<ul>
<li>A Hosted Service reads the messages from the Rabbitmq <em>&ldquo;sample_2&rdquo;</em> queue and stores them into a Redis cache database.</li>
</ul>
</li>
</ul>
<p>These applications are not currently utilizing OpenTelemetry. Therefore, in the following sections, we will provide a step-by-step guide on how to set up and use the OpenTelemetry client.</p>
<h1 id="opentelemetry-net-client"><strong>OpenTelemetry .NET Client</strong></h1>
<p>To get started with OpenTelemetry we&rsquo;re going to need the following packages.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;OpenTelemetry&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.8.0&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;OpenTelemetry.Instrumentation.AspNetCore&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.8.1&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;OpenTelemetry.Exporter.OpenTelemetryProtocol&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.8.0&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;OpenTelemetry.Extensions.Hosting&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.8.0&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;OpenTelemetry.Instrumentation.Http&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.8.1&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;OpenTelemetry.Instrumentation.SqlClient&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.8.0-beta.1&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;PackageReference</span> <span style="color:#a6e22e">Include=</span><span style="color:#e6db74">&#34;ZiggyCreatures.FusionCache.OpenTelemetry&#34;</span> <span style="color:#a6e22e">Version=</span><span style="color:#e6db74">&#34;1.0.0&#34;</span> <span style="color:#f92672">/&gt;</span>
</span></span></code></pre></div><ul>
<li>The <em><strong>OpenTelemetry</strong></em> package is the core library.</li>
<li>The <em><strong>OpenTelemetry.Exporter.OpenTelemetryProtocol</strong></em> package enables us to send traces to a compatible OTLP endpoint. For this demo, the traces will be send to Jaeger.
<ul>
<li><em>In previous versions of OpenTelemetry, the NuGet package <code>OpenTelemetry.Exporter.Jaeger</code> was used to send traces to Jaeger. This package is now deprecated in favor of <code>OpenTelemetry.Exporter.OpenTelemetryProtocol</code>.</em></li>
</ul>
</li>
<li>The <em><strong>OpenTelemetry.Extensions.Hosting</strong></em>  package contains extensions that allows us to configure the TraceProvider.</li>
<li>The <em><strong>OpenTelemetry.Instrumentation.</strong>*</em> packages are instrumentation libraries. These packages instrument common libraries, functionalities, and classes, reducing the need for manual implementation. In our demo, we&rsquo;re using the following ones:
<ul>
<li>The <em><strong>OpenTelemetry.Instrumentation.AspNetCore</strong></em> instruments <em>ASP.NET Core</em> and collects telemetry about incoming web requests. This instrumentation also collects incoming gRPC requests using <em>Grpc.AspNetCore</em>.</li>
<li>The <em><strong>OpenTelemetry.Instrumentation.Http</strong></em> instruments the <em>System.Net.Http.HttpClient</em> and <em>System.Net.HttpWebRequest</em> types and collects telemetry about outgoing HTTP requests.</li>
<li>The <em><strong>OpenTelemetry.Instrumentation.SqlClient</strong></em> instruments the <em>Microsoft.Data.SqlClient</em> and <em>System.Data.SqlClient</em> types and collects telemetry about database operations.</li>
</ul>
</li>
<li>To interact with Redis, we&rsquo;re going to use the <a href="https://github.com/ZiggyCreatures/FusionCache">FusionCache</a> library. It is an easy-to-use library with quite a few advanced features. To instrument the FusionCache library, we&rsquo;re using the <code>ZiggyCreatures.FusionCache.OpenTelemetry</code> library. This library collects telemetry about outgoing calls to the cache.</li>
</ul>
<p>In the near future, I anticipate seeing more and more instrumentation libraries like these. This will allow us to effortlessly instrument the most commonly used dependencies. Simply install a NuGet package, add some configuration lines to your app, and you&rsquo;re all set.</p>
<h1 id="adding-opentelemetry-on-app1"><strong>Adding OpenTelemetry on App1</strong></h1>
<h2 id="1-setup-the-opentelemetry-library"><strong>1. Setup the OpenTelemetry library</strong></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>services.AddOpenTelemetry().WithTracing(builder =&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    builder.AddAspNetCoreInstrumentation()
</span></span><span style="display:flex;"><span>        .AddHttpClientInstrumentation()
</span></span><span style="display:flex;"><span>        .AddSource(nameof(PublishMessageController))
</span></span><span style="display:flex;"><span>        .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService(<span style="color:#e6db74">&#34;App1&#34;</span>))
</span></span><span style="display:flex;"><span>        .AddOtlpExporter(opts =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            opts.Endpoint =
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> Uri(<span style="color:#e6db74">$&#34;{Config[&#34;</span>Jaeger:Protocol<span style="color:#e6db74">&#34;]}://{Config[&#34;</span>Jaeger:Host<span style="color:#e6db74">&#34;]}:{Config[&#34;</span>Jaeger:Port<span style="color:#e6db74">&#34;]}&#34;</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>This is the first app we&rsquo;re instrumenting, so I&rsquo;ll explain what we&rsquo;re doing line by line.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>AddAspNetCoreInstrumentation()
</span></span></code></pre></div><p>This enables .NET Core instrumentation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>AddHttpClientInstrumentation()
</span></span></code></pre></div><p>This enables HTTP Instrumentation. App1 makes an HTTP request to App2. If we want to trace the HTTP call between these two apps, we can do it simply by adding this extension method.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>.AddSource(nameof(PublishMessageController))
</span></span></code></pre></div><p>The <code>AddSource</code> method can be used to add an <code>ActivitySource</code> to the provider. Multiple <code>AddSource</code> methods can be called to add more than one span.</p>
<p>Why do we need this? App1 queues a message into a rabbit queue and we want to record this trace.<br>
OpenTelemetry has many instrumentation libraries, but none are available for RabbitMQ. To create a distributed transaction between two applications that communicate using RabbitMQ, we must implement it ourselves, using an Activity.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>SetResourceBuilder(ResourceBuilder.CreateDefault().AddService(<span style="color:#e6db74">&#34;App1&#34;</span>))
</span></span></code></pre></div><p>A Resource is the immutable representation of the entity producing the telemetry.<br>
With the <code>SetResourceBuilder</code> method, we&rsquo;re configuring the Resource for the application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>AddOtlpExporter(opts =&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    opts.Endpoint =
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Uri(<span style="color:#e6db74">$&#34;{Config[&#34;</span>Jaeger:Protocol<span style="color:#e6db74">&#34;]}://{Config[&#34;</span>Jaeger:Host<span style="color:#e6db74">&#34;]}:{Config[&#34;</span>Jaeger:Port<span style="color:#e6db74">&#34;]}&#34;</span>);
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>This method is used to specify the endpoint to which the traces will be sent. Every trace in this demo will be transmitted directly to a Jaeger instance.</p>
<h2 id="2-instrument-dependency-calls"><strong>2. Instrument dependency calls</strong></h2>
<p>Unlike the HTTP request, OpenTelemetry does not yet have support for automatic RabbitMq trace correlation.</p>
<p>The code below demonstrates how the <em>&ldquo;publish message&rdquo;</em> trace can be created. The code snippet adds the trace information to the enqueued message header, which will later be used to link both operations.</p>
<p>Specifically, we are using a Propagator to inject the activity into the message header that is going to be queued to Rabbit. Subsequently, the consumer application will use another Propagator to extract the Activity and link the producer activity with the consumer activity.</p>
<p>We are also using the Tags attribute to store relevant metadata into the Activity.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#a6e22e">[ApiController]</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">[Route(&#34;publish-message&#34;)]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">PublishMessageController</span>(
</span></span><span style="display:flex;"><span>    ILogger&lt;PublishMessageController&gt; logger,
</span></span><span style="display:flex;"><span>    IConfiguration configuration)
</span></span><span style="display:flex;"><span>    : ControllerBase
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> ActivitySource Activity = <span style="color:#66d9ef">new</span>(nameof(PublishMessageController));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> TextMapPropagator Propagator = Propagators.DefaultTextMapPropagator;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e">    [HttpGet]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Get()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> activity = Activity.StartActivity(<span style="color:#e6db74">&#34;RabbitMq Publish&#34;</span>, ActivityKind.Producer))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> factory = <span style="color:#66d9ef">new</span> ConnectionFactory { HostName = configuration[<span style="color:#e6db74">&#34;RabbitMq:Host&#34;</span>] };
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> connection = factory.CreateConnection())
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> channel = connection.CreateModel())
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> props = channel.CreateBasicProperties();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    AddActivityToHeader(activity, props);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    channel.QueueDeclare(queue: <span style="color:#e6db74">&#34;sample&#34;</span>,
</span></span><span style="display:flex;"><span>                        durable: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>                        exclusive: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>                        autoDelete: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>                        arguments: <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">var</span> body = Encoding.UTF8.GetBytes(<span style="color:#e6db74">&#34;I am app1&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    logger.LogInformation(<span style="color:#e6db74">&#34;Publishing message to queue&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    channel.BasicPublish(exchange: <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>                        routingKey: <span style="color:#e6db74">&#34;sample&#34;</span>,
</span></span><span style="display:flex;"><span>                        basicProperties: props,
</span></span><span style="display:flex;"><span>                        body: body);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception e)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            logger.LogError(e, <span style="color:#e6db74">&#34;Error trying to publish a message&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> AddActivityToHeader(Activity activity, IBasicProperties props)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        Propagator.Inject(<span style="color:#66d9ef">new</span> PropagationContext(activity.Context, Baggage.Current), props, InjectContextIntoHeader);
</span></span><span style="display:flex;"><span>        activity?.SetTag(<span style="color:#e6db74">&#34;messaging.system&#34;</span>, <span style="color:#e6db74">&#34;rabbitmq&#34;</span>);
</span></span><span style="display:flex;"><span>        activity?.SetTag(<span style="color:#e6db74">&#34;messaging.destination_kind&#34;</span>, <span style="color:#e6db74">&#34;queue&#34;</span>);
</span></span><span style="display:flex;"><span>        activity?.SetTag(<span style="color:#e6db74">&#34;messaging.rabbitmq.queue&#34;</span>, <span style="color:#e6db74">&#34;sample&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> InjectContextIntoHeader(IBasicProperties props, <span style="color:#66d9ef">string</span> key, <span style="color:#66d9ef">string</span> <span style="color:#66d9ef">value</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            props.Headers ??= <span style="color:#66d9ef">new</span> Dictionary&lt;<span style="color:#66d9ef">string</span>, <span style="color:#66d9ef">object</span>&gt;();
</span></span><span style="display:flex;"><span>            props.Headers[key] = <span style="color:#66d9ef">value</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            logger.LogError(ex, <span style="color:#e6db74">&#34;Failed to inject trace context.&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="adding-opentelemetry-on-app2"><strong>Adding OpenTelemetry on App2</strong></h1>
<h2 id="1-set-up-the-opentelemetry-library"><strong>1. Set up the OpenTelemetry library</strong></h2>
<p>App2 is a console app, so we have to set up the library in a different way. IInstead of using an <code>IServiceCollection</code> extension, we&rsquo;re directly creating a <code>TraceProvider</code>. Apart from that, the setup looks pretty much the same.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>Sdk.CreateTracerProviderBuilder()
</span></span><span style="display:flex;"><span>  .AddHttpClientInstrumentation()
</span></span><span style="display:flex;"><span>  .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService(<span style="color:#e6db74">&#34;App2&#34;</span>))
</span></span><span style="display:flex;"><span>  .AddSource(nameof(Program))
</span></span><span style="display:flex;"><span>  .AddOtlpExporter(opts =&gt;
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      opts.Endpoint =
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">new</span> Uri(<span style="color:#e6db74">$&#34;{_config[&#34;</span>Jaeger:Protocol<span style="color:#e6db74">&#34;]}://{_config[&#34;</span>Jaeger:Host<span style="color:#e6db74">&#34;]}:{_config[&#34;</span>Jaeger:Port<span style="color:#e6db74">&#34;]}&#34;</span>);
</span></span><span style="display:flex;"><span>  })
</span></span><span style="display:flex;"><span>  .Build();
</span></span></code></pre></div><h2 id="2-instrument-dependency-calls-1"><strong>2. Instrument dependency calls</strong></h2>
<p>The HTTP call is being instrumented automatically thanks to the <code>AddHttpClientInstrumentation</code> extension method, but this app also dequeues a message from Rabbit, so we want to instrument that part.<br>
The code is pretty much the same as the one we have created for the Rabbit producer on App1, the only difference is that instead of injecting the activity we are to extracting it from the message header.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">async</span> Task ProcessMessage(BasicDeliverEventArgs ea,
</span></span><span style="display:flex;"><span>            HttpClient httpClient,
</span></span><span style="display:flex;"><span>            IModel rabbitMqChannel)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">//Extract the activity and set it into the current one</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">var</span> parentContext = Propagator.Extract(<span style="color:#66d9ef">default</span>, ea.BasicProperties, ExtractTraceContextFromBasicProperties);
</span></span><span style="display:flex;"><span>      Baggage.Current = parentContext.Baggage;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">//Start a new Activity</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">using</span> (<span style="color:#66d9ef">var</span> activity = Activity.StartActivity(<span style="color:#e6db74">&#34;Process Message&#34;</span>, ActivityKind.Consumer, parentContext.ActivityContext))
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">var</span> body = ea.Body.ToArray();
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">var</span> message = Encoding.UTF8.GetString(body);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">//Add Tags to the Activity</span>
</span></span><span style="display:flex;"><span>          AddActivityTags(activity);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          _logger.LogInformation(<span style="color:#e6db74">&#34;Message Received: &#34;</span> + message);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          _ = <span style="color:#66d9ef">await</span> httpClient.PostAsync(<span style="color:#e6db74">&#34;/sql-to-event&#34;</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#66d9ef">new</span> StringContent(JsonSerializer.Serialize(message),
</span></span><span style="display:flex;"><span>                  Encoding.UTF8,
</span></span><span style="display:flex;"><span>                  <span style="color:#e6db74">&#34;application/json&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          rabbitMqChannel.BasicAck(deliveryTag: ea.DeliveryTag, multiple: <span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _logger.LogError(<span style="color:#e6db74">$&#34;There was an error processing the message: {ex} &#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Extract the Activity from the message header</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> IEnumerable&lt;<span style="color:#66d9ef">string</span>&gt; ExtractTraceContextFromBasicProperties(IBasicProperties props, <span style="color:#66d9ef">string</span> key)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (props.Headers.TryGetValue(key, <span style="color:#66d9ef">out</span> <span style="color:#66d9ef">var</span> <span style="color:#66d9ef">value</span>))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">var</span> bytes = <span style="color:#66d9ef">value</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">byte</span>[];
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span>[] { Encoding.UTF8.GetString(bytes) };
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">catch</span> (Exception ex)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _logger.LogError(<span style="color:#e6db74">$&#34;Failed to extract trace context: {ex}&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Enumerable.Empty&lt;<span style="color:#66d9ef">string</span>&gt;();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//Add Tags to the Activity</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> AddActivityTags(Activity activity)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    activity?.SetTag(<span style="color:#e6db74">&#34;messaging.system&#34;</span>, <span style="color:#e6db74">&#34;rabbitmq&#34;</span>);
</span></span><span style="display:flex;"><span>    activity?.SetTag(<span style="color:#e6db74">&#34;messaging.destination_kind&#34;</span>, <span style="color:#e6db74">&#34;queue&#34;</span>);
</span></span><span style="display:flex;"><span>    activity?.SetTag(<span style="color:#e6db74">&#34;messaging.rabbitmq.queue&#34;</span>, <span style="color:#e6db74">&#34;sample&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="adding-opentelemetry-on-app3"><strong>Adding OpenTelemetry on App3</strong></h1>
<h2 id="1-setup-the-opentelemetry-library-1"><strong>1. Setup the OpenTelemetry library</strong></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>services.AddOpenTelemetry().WithTracing(builder =&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    builder.AddAspNetCoreInstrumentation()
</span></span><span style="display:flex;"><span>        .AddSource(nameof(RabbitRepository))
</span></span><span style="display:flex;"><span>        .AddSqlClientInstrumentation()
</span></span><span style="display:flex;"><span>        .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService(<span style="color:#e6db74">&#34;App3&#34;</span>))
</span></span><span style="display:flex;"><span>        .AddOtlpExporter(opts =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            opts.Endpoint = 
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> Uri(<span style="color:#e6db74">$&#34;{Config[&#34;</span>Jaeger:Protocol<span style="color:#e6db74">&#34;]}://{Config[&#34;</span>Jaeger:Host<span style="color:#e6db74">&#34;]}:{Config[&#34;</span>Jaeger:Port<span style="color:#e6db74">&#34;]}&#34;</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>The setup looks almost identical to those on App1 and App2. However, there is one notable difference:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>AddSqlClientInstrumentation()
</span></span></code></pre></div><p>This application does not make any HTTP requests. Instead, it queries a database. Therefore, we&rsquo;re using the SQL extension method to enable SQL instrumentation. We&rsquo;re essentially replacing the <code>OpenTelemetry.Instrumentation.Http</code> library with the <code>OpenTelemetry.Instrumentation.SqlClient</code> library.</p>
<p>This application also enqueues a message into a RabbitMQ queue, but the code is exactly the same as the one I have shown you in the App1 section.</p>
<h1 id="adding-opentelemetry-on-app4"><strong>Adding OpenTelemetry on App4</strong></h1>
<h2 id="1-setup-the-opentelemetry-library-2"><strong>1. Setup the OpenTelemetry library</strong></h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>builder.Services.AddFusionCache()
</span></span><span style="display:flex;"><span>    .WithSerializer(<span style="color:#66d9ef">new</span> FusionCacheSystemTextJsonSerializer())
</span></span><span style="display:flex;"><span>    .WithBackplane(
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> RedisBackplane(<span style="color:#66d9ef">new</span> RedisBackplaneOptions { Configuration = <span style="color:#e6db74">$&#34;{builder.Configuration[&#34;</span>Redis:Host<span style="color:#e6db74">&#34;]}:{builder.Configuration[&#34;</span>Redis:Port<span style="color:#e6db74">&#34;]}&#34;</span> })
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>builder.Services.AddOpenTelemetry().WithTracing(b =&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    b.AddAspNetCoreInstrumentation()
</span></span><span style="display:flex;"><span>        .AddHttpClientInstrumentation()
</span></span><span style="display:flex;"><span>        .AddFusionCacheInstrumentation()
</span></span><span style="display:flex;"><span>        .AddSource(nameof(Worker))
</span></span><span style="display:flex;"><span>        .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService(<span style="color:#e6db74">&#34;App4&#34;</span>))
</span></span><span style="display:flex;"><span>        .AddOtlpExporter(opts =&gt;
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            opts.Endpoint =
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> Uri(
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">$&#34;{builder.Configuration[&#34;</span>Jaeger:Protocol<span style="color:#e6db74">&#34;]}://{builder.Configuration[&#34;</span>Jaeger:Host<span style="color:#e6db74">&#34;]}:{builder.Configuration[&#34;</span>Jaeger:Port<span style="color:#e6db74">&#34;]}&#34;</span>);
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>This application dequeues a message from a RabbitMQ queue and stores the message content in a Redis cache database.</p>
<p>The instrumentation for dequeuing the message from RabbitMQ is identical to the snippet I provided in the App2 section, so I won&rsquo;t repeat that here.</p>
<p>To start using OpenTelemetry with FusionCache, we simply need to utilize the <code>AddFusionCacheInstrumentation</code> method from the <code>ZiggyCreatures.FusionCache.OpenTelemetry</code> NuGet package when configuring the <code>TraceProvider</code>.</p>
<p>Also, before setting up OpenTelemetry, we need to configure FusionCache to use Redis as a backplane.</p>
<h1 id="jaeger"><strong>Jaeger</strong></h1>
<p>After integrating the OpenTelemetry library into these four applications, we will generate some traffic and then access Jaeger to start analyzing the traces that the applications are sending.</p>
<p>If we examine an entire trace, here is how it appears:</p>
<p><img alt="otel-jaeger" src="/img/otel-jaeger.png"></p>
<p>Let me simplify it a bit for you. That&rsquo;s a magnified image of the spans we have created in our trace.</p>
<p><img alt="otel-jaeger-span" src="/img/otel-jaeger-span.png"></p>
<ul>
<li>
<p>The first span (publish-message) corresponds to the App1 API endpoint. This span is automatically created when the API controller is executed, thanks to the <code>AddAspNetCoreInstrumentation()</code> extension method.</p>
</li>
<li>
<p>The second span (RabbitMq publish) is an Activity that we have manually created in App1. You can see the code snippet on the &ldquo;Adding OpenTelemetry on App1&rdquo; section.</p>
</li>
<li>
<p>The third span (Process Message) is an Activity that we have manually created in App2. You can also see the code snippet in the &ldquo;Adding OpenTelemetry on App2&rdquo; section.</p>
</li>
<li>
<p>The fourth span (HTTP POST) corresponds to the HTTP request that the App2 is making to App3. This span is automatically created thanks to the <code>AddHttpClientInstrumentation()</code> extension method found in the App2 setup.</p>
</li>
<li>
<p>The fifth span (sql-to-event) corresponds to the App3 /sql-to-event API endpoint. This span is automatically created when the API controller is executed, thanks to the <code>AddAspNetCoreInstrumentation()</code> extension method.</p>
</li>
<li>
<p>The sixth span (sqlserver) corresponds to the SQL query that App3 is executing. This span is automatically created thanks to the <code>AddSqlClientInstrumentation()</code> extension method.</p>
</li>
<li>
<p>The seventh span (RabbitMq publish) is an Activity that we have manually created in App3.</p>
</li>
<li>
<p>The eigth span (Process Message) is an Activity that we have manually created in App4.</p>
</li>
<li>
<p>The last three spans correspond to the Redis instructions that we are executing in App4. These three spans are  automatically created thanks to the <code>AddFusionCacheInstrumentation()</code> extension method.</p>
</li>
</ul>
<p>If we want more information on any span, we can drill down and inspect the metadata. For example, if we inspect the &ldquo;HTTP POST&rdquo; span, we can see more details about it.</p>
<p><img alt="otel-jaeger-http-instrumentation" src="/img/otel-jaeger-http-instrumentation.png"></p>
<p>Also, do you remember that in the App1 we added some extra Tags on the Activity?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>activity?.SetTag(<span style="color:#e6db74">&#34;messaging.system&#34;</span>, <span style="color:#e6db74">&#34;rabbitmq&#34;</span>);
</span></span><span style="display:flex;"><span>activity?.SetTag(<span style="color:#e6db74">&#34;messaging.destination_kind&#34;</span>, <span style="color:#e6db74">&#34;queue&#34;</span>);
</span></span><span style="display:flex;"><span>activity?.SetTag(<span style="color:#e6db74">&#34;messaging.rabbitmq.queue&#34;</span>, <span style="color:#e6db74">&#34;sample&#34;</span>);
</span></span></code></pre></div><p>Here is the how it look on Jaeger.</p>
<p><img alt="otel-jaeger-rabbit-tags" src="/img/otel-jaeger-rabbit-tags.png"></p>
<p>Jaeger is also capable giving you a dependency-graph after looking at the traces.</p>
<p><img alt="otel-jaeger-dag" src="/img/otel-jaeger-dag.png"></p>
<p>Also it is capable of giving quite a few of performance statistics.</p>
<ul>
<li>Trace Statistics</li>
</ul>
<p><img alt="otel-jaeger-statistics" src="/img/otel-jaeger-statistics.png"></p>
<ul>
<li>Span Statistics</li>
</ul>
<p><img alt="otel-jaeger-statistics-span" src="/img/otel-jaeger-statistics-by-span.png"></p>
<ul>
<li>Flamegraph Statistics</li>
</ul>
<p><img alt="otel-jaeger-statistics-fg" src="/img/otel-jaeger-statistics-flamegraph.png"></p>
<p>A comparison of traces is also possible.</p>
<p><img alt="otel-jaeger-compare-traces" src="/img/otel-jaeger-compare-traces.png"></p>
<p>If we examine the comparison more closely, we can see that the Redis spans are not present in the second trace because we have implemented a read-through cache pattern.</p>
<p><img alt="otel-jaeger-compare-traces-zoom" src="/img/otel-jaeger-compare-traces-zoom.png"></p>
<h1 id="how-to-test-the-example-apps">How to test the example apps</h1>
<p>If you want to take a closer look at the four applications, I have uploaded everything on my <a href="https://github.com/karlospn/opentelemetry-tracing-demo">GitHub repository</a></p>
<p>If you want to try executing this example yourself, I have also uploaded a <code>docker-compose</code> file with everything you need. You can simply run a <code>docker compose up</code>, and you&rsquo;re all set.</p>
<p>However, there&rsquo;s a small caveat I wanted to mention regarding the <code>docker-compose</code> file.</p>
<p>With <code>docker-compose</code>, ou can control the order of service startup and shutdown using the <code>depends_on</code> option, but it doesn&rsquo;t wait until a container is &ldquo;ready&rdquo; - it only waits until it&rsquo;s running.</p>
<p>In my case, this is a problem because App2 and App4 need to wait for the RabbitMQ container to be ready. To circumvent this issue, the compose file overwrites the &ldquo;entrypoint&rdquo; for both apps and executes a shell script that makes both apps sleep for 30 seconds before starting up.</p>
<p>Here&rsquo;s the docker-compose file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">version</span>: <span style="color:#e6db74">&#39;3.4&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tracing</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tracing-network</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span><span style="color:#f92672">services</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rabbitmq</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">rabbitmq:3.13.1-management</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">15672</span>:<span style="color:#ae81ff">15672</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">5672</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tracing</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sqlserver</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">mcr.microsoft.com/mssql/server:2019-GA-ubuntu-16.04</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">ACCEPT_EULA=Y</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">SA_PASSWORD=Pass@Word1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">1433</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tracing</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">redis</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">redis:7.2.4</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">6379</span>:<span style="color:#ae81ff">6379</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tracing</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jaeger</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">image</span>: <span style="color:#ae81ff">jaegertracing/all-in-one:1.56.0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">container_name</span>: <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">restart</span>: <span style="color:#ae81ff">unless-stopped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">5775</span>:<span style="color:#ae81ff">5775</span><span style="color:#ae81ff">/udp</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">6831</span>:<span style="color:#ae81ff">6831</span><span style="color:#ae81ff">/udp</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">6832</span>:<span style="color:#ae81ff">6832</span><span style="color:#ae81ff">/udp</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">5778</span>:<span style="color:#ae81ff">5778</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">16686</span>:<span style="color:#ae81ff">16686</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">14250</span>:<span style="color:#ae81ff">14250</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">14268</span>:<span style="color:#ae81ff">14268</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">14269</span>:<span style="color:#ae81ff">14269</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">4317</span>:<span style="color:#ae81ff">4317</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">4318</span>:<span style="color:#ae81ff">4318</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">9411</span>:<span style="color:#ae81ff">9411</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tracing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">COLLECTOR_OTLP_ENABLED</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app1</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./App1.WebApi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;5000:8080&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tracing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">rabbitmq</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Protocol</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Port</span>: <span style="color:#ae81ff">4317</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Host</span>: <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RabbitMq__Host</span>: <span style="color:#ae81ff">rabbitmq</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">App3Endpoint</span>: <span style="color:#ae81ff">http://app3:8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app2</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">stdin_open</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">tty</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./App2.RabbitConsumer.Console</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tracing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">rabbitmq</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">app3</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">entrypoint</span>: [<span style="color:#e6db74">&#34;./wait.sh&#34;</span>, <span style="color:#e6db74">&#34;30&#34;</span>, <span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;App2.RabbitConsumer.Console.dll&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Protocol</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Port</span>: <span style="color:#ae81ff">4317</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Host</span>: <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RabbitMq__Host</span>: <span style="color:#ae81ff">rabbitmq</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">App3UriEndpoint</span>: <span style="color:#ae81ff">http://app3:8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app3</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./App3.WebApi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#e6db74">&#34;5001:8080&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tracing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">rabbitmq</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">sqlserver</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Protocol</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Port</span>: <span style="color:#ae81ff">4317</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Host</span>: <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RabbitMq__Host</span>: <span style="color:#ae81ff">rabbitmq</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">SqlDbConnString</span>: <span style="color:#ae81ff">server=sqlserver;user id=sa;password=Pass@Word1;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">app4</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">build</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">context</span>: <span style="color:#ae81ff">./App4.RabbitConsumer.HostedService</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">networks</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tracing</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">depends_on</span>: 
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">rabbitmq</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">entrypoint</span>: [<span style="color:#e6db74">&#34;./wait.sh&#34;</span>, <span style="color:#e6db74">&#34;30&#34;</span>, <span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;App4.RabbitConsumer.HostedService.dll&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">environment</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Protocol</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Port</span>: <span style="color:#ae81ff">4317</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Jaeger__Host</span>: <span style="color:#ae81ff">jaeger</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">RabbitMq__Host</span>: <span style="color:#ae81ff">rabbitmq</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Redis__Host</span>: <span style="color:#ae81ff">redis</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">Redis__Port</span>: <span style="color:#ae81ff">6379</span>
</span></span></code></pre></div>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://www.mytechramblings.com/posts/building-an-azure-devops-copilot-using-semantic-kernel-and-azure-openai/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Building an Azure DevOps Copilot using .NET 8, Semantic Kernel and Azure OpenAI GPT-4o</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://www.mytechramblings.com/posts/building-a-dotnet-news-aggregator-site/">
                  <span class="button__text">Announcing dotnetramblings.com or how to build a .NET news aggregator site</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2024 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://www.mytechramblings.com/assets/main.js"></script>
<script src="https://www.mytechramblings.com/assets/prism.js"></script>
<script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
<script>
  kofiWidgetOverlay.draw('carlospons', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Donate',
    'floating-chat.donateButton.background-color': '#ff5f5f',
    'floating-chat.donateButton.text-color': '#fff'
  });
</script>

      
    </div>

    
      
  
    
      
    
  


    
  </body>
</html>
