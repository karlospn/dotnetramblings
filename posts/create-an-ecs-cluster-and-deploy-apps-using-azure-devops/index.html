<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>An opinionated approach about how to create an AWS ECS Fargate cluster and deploy apps on it using Azure DevOps Pipelines :: my tech ramblings — A blog for writing about my techie ramblings</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="These past couple of weeks I&amp;rsquo;ve been tinkering with AWS ECS Fargate and after losing some time tackling different approaches I thought it might be useful to write down what I ended up building.
My goal was trying to build an AWS ECS Fargate cluster and deploy apps on it using Azure DevOps Pipelines and I had 3 clear objectives I wanted to achieve.
All the infrastructure in AWS must be created using IaC (infrastructure-as-code) and must be created using an Azure DevOps pipeline."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://www.mytechramblings.com/posts/create-an-ecs-cluster-and-deploy-apps-using-azure-devops/" />





<link rel="stylesheet" href="https://www.mytechramblings.com/assets/style.css">


<link rel="stylesheet" href="https://www.mytechramblings.com/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.mytechramblings.com/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://www.mytechramblings.com/img/favicon.png">



  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="An opinionated approach about how to create an AWS ECS Fargate cluster and deploy apps on it using Azure DevOps Pipelines">
  <meta name="twitter:description" content="These past couple of weeks I&#39;ve been tinkering with AWS ECS Fargate and after losing some time tackling different approaches I thought it might be useful to write down what I ended up building, so without further ado let&#39;s dig in.">



<meta property="og:url" content="https://www.mytechramblings.com/posts/create-an-ecs-cluster-and-deploy-apps-using-azure-devops/">
  <meta property="og:site_name" content="my tech ramblings">
  <meta property="og:title" content="An opinionated approach about how to create an AWS ECS Fargate cluster and deploy apps on it using Azure DevOps Pipelines">
  <meta property="og:description" content="These past couple of weeks I&#39;ve been tinkering with AWS ECS Fargate and after losing some time tackling different approaches I thought it might be useful to write down what I ended up building, so without further ado let&#39;s dig in.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-11-10T10:10:18+01:00">
    <meta property="article:modified_time" content="2020-11-10T10:10:18+01:00">
    <meta property="article:tag" content="Aws">
    <meta property="article:tag" content="Ecr">
    <meta property="article:tag" content="Ecs">
    <meta property="article:tag" content="Containers">
    <meta property="article:tag" content="Devops">
    <meta property="article:tag" content="Cdk">






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://www.mytechramblings.com/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">my tech ramblings</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="https://www.dotnetramblings.com">.NET News</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="https://www.dotnetramblings.com">.NET News</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://www.mytechramblings.com/posts/create-an-ecs-cluster-and-deploy-apps-using-azure-devops/">An opinionated approach about how to create an AWS ECS Fargate cluster and deploy apps on it using Azure DevOps Pipelines</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-11-10
        </span>

        
          
            



          
        
      

      
      
        <span class="post-read-time">— 9 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://www.mytechramblings.com/tags/aws/">aws</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/ecr/">ecr</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/ecs/">ecs</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/containers/">containers</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/devops/">devops</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/cdk/">cdk</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/azure/">azure</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <p>These past couple of weeks I&rsquo;ve been tinkering with AWS ECS Fargate and after losing some time tackling different approaches I thought it might be useful to write down what I ended up building.</p>
<p>My goal was trying to build an AWS ECS Fargate cluster and deploy apps on it using Azure DevOps Pipelines and I had 3 clear objectives I wanted to achieve.</p>
<ul>
<li><strong>All the infrastructure in AWS must be created using IaC</strong> (infrastructure-as-code) and must be created using an <strong>Azure DevOps pipeline</strong>.</li>
<li>The <strong>application</strong> must be build and deployed also using an <strong>Azure DevOps pipeline</strong>.</li>
<li>I want to <strong>decouple the creation deployment and lifecycle of the infrastructure from the application codebase.</strong></li>
</ul>
<p>My first approach was trying to emulate this post on the official AWS blog: <a href="https://aws.amazon.com/es/blogs/devops/deploying-a-asp-net-core-web-application-to-amazon-ecs-using-an-azure-devops-pipeline">https://aws.amazon.com/es/blogs/devops/deploying-a-asp-net-core-web-application-to-amazon-ecs-using-an-azure-devops-pipeline</a>, but I didn&rsquo;t like that approach. Let me explain a little bit my pain points with this approach:</p>
<p>1- I didn&rsquo;t want to deploy images using the &rsquo;latest&rsquo; tag strategy.</p>
<p>To deploy a container into ECS you need to create a &ldquo;ECS Task Definition&rdquo;.<br>
An ECS Task Definition contains among many other attributes the Uri and tag of the image you want to ran, so if you put something like &lsquo;uri:latest&rsquo; as the value of the attribute you don&rsquo;t need to create a new Task Definition everytime you deploy a new version of the same container because it will always pick the image with the &rsquo;latest&rsquo; tag.<br>
That&rsquo;s a neat trick, but I really like to avoid deployments with stable tags like the &rsquo;latest&rsquo; tag, because those tags continue to receive updates and can introduce unwanted inconsistencies. I prefer to use unique tags for every deployment like the container build Id.</p>
<p>2- The post only explains how to create a pipeline that updates and already running container, but how should I deploy my application the first time? How should I create the ECS Task Definition and the ECS Service the first time? Those questions are linked with one of my <strong>biggest pain points</strong> when working with ECS:</p>
<ul>
<li><strong>You need an existing image to create an ECS Task Definition</strong></li>
</ul>
<p>And why is it a problem? Because what I like to do is to create the application infrastructure first and then deploy the app. Both things can be deployed using the same pipeline but I don&rsquo;t like to do it at the same time.<br>
I like to create the infrastructure first and then deploy the application, and the fact that you need and existing image to create an ECS Task Definition, forces me to do something along these lines:</p>
<ul>
<li>Create the ECS Fargate cluster and the Application Load Balancer (ALB).</li>
<li>Compile the application source code, run the tests, create the image and push it into an ECR repository.</li>
<li>Create the ECS Task Definition that points to the image I have pushed in the previous step.</li>
<li>Create the ALB Target Group which will contain the ECS tasks.</li>
<li>Create the ECS Service.</li>
</ul>
<p>So in my mind it seems that I&rsquo;m intermingling the creation of the infrastructure with the application CI/CD. And I don&rsquo;t like it&hellip;</p>
<p>In my perfect world I would rather do something like this:</p>
<ul>
<li>Create the ECS Fargate cluster</li>
<li>Create the ALB</li>
<li>Create the ECS Task Definition</li>
<li>Create the ALB target Group</li>
<li>Create the ECS Service</li>
</ul>
<p>And after all the infrastructure required to run my application is created then deploy the application onto that infrastructure. And that&rsquo;s exactly what I end up building, I&rsquo;m sure that some people might not agree with that approach and find the other one completely fine, but that&rsquo;s not my case&hellip;</p>
<p>At the end I built 3 pipelines:</p>
<ul>
<li>A pipeline to create a dummy application.</li>
<li>A pipeline to create the infrastructure on AWS.</li>
<li>A pipeline to build and deploy the application.<br>
Let me explain a little bit about the purpose of every pipeline and how everything works together.</li>
</ul>
<h1 id="1-create-and-deploy-a-_dummy_-application">1. Create and deploy a <em>&ldquo;dummy&rdquo;</em> application</h1>
<p>As I have stated before you need an existing image when creating an ECS Task Definition so I decided to create a &ldquo;dummy&rdquo; application.<br>
That &ldquo;dummy&rdquo; application is going to be used when provisioning the infrastructure, so when all my infrastructure is provisioned I&rsquo;ll have an ECS cluster running a &ldquo;dummy&rdquo; / &ldquo;hello-world&rdquo; application. And afterwards when the application CI/CD pipeline kicks in is going to swap the dummy application with the real one.</p>
<p>So that&rsquo;s the first pipeline:</p>
<p><img alt="push-dummy-image-to-ecr" src="/img/push-dummy-image-to-ecr.png"></p>
<p>It&rsquo;s a very simple pipeline: build the container image and push it into an ECR repository.</p>
<ul>
<li>That pipeline will only run <strong>ONCE</strong> and that&rsquo;s it.</li>
</ul>
<p>And why is it going to run just once? Because I&rsquo;m using that image as a stepping stone so I can create all my infrastructure without needing to reference a real container image.<br>
Once the image is pushed into a generic ECR repository I can reuse it for all the applications that I decide to spun up inside my ECS cluster.</p>
<p>So that&rsquo;s the first pipeline you are going to ran and you can ran it whenever you want as long as it is the first one.</p>
<p>As I said it&rsquo;s a very simple pipeline, take a look:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">trigger</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">branches</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">master</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">exclude</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;azure-pipelines.yml&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">pool</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vmImage</span>: <span style="color:#e6db74">&#39;ubuntu-latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">AWS_ACCOUNT_ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">1234567789927</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">APP_NAME</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">dummy</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">DOCKERFILE_PATH</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">Dummy.WebApi/Dockerfile</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">AWS_REGION</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value </span>: <span style="color:#ae81ff">eu-west-1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">TAG</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">$(Build.BuildId)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">stages</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">stage</span>: <span style="color:#e6db74">&#39;BuildAndPushToECR&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job</span>: <span style="color:#e6db74">&#39;Build&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:    
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo Starting docker build
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo docker build -t $(APP_NAME):$(TAG) -f $(System.DefaultWorkingDirectory)/$(DOCKERFILE_PATH) .
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        docker build -t $(APP_NAME):$(TAG) -f $(System.DefaultWorkingDirectory)/$(DOCKERFILE_PATH) .</span>        
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Run docker build&#39;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   - <span style="color:#f92672">task</span>: <span style="color:#ae81ff">ECRPushImage@1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">displayName</span>:  <span style="color:#ae81ff">Push image to Dev ECR</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">inputs</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS ECR Dev&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;$(AWS_REGION)&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imageSource</span>: <span style="color:#e6db74">&#39;imagename&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">sourceImageName</span>: <span style="color:#e6db74">&#39;$(APP_NAME)&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">sourceImageTag</span>: <span style="color:#e6db74">&#39;$(TAG)&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">repositoryName</span>: <span style="color:#e6db74">&#39;$(APP_NAME)&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pushTag</span>: <span style="color:#e6db74">&#39;$(TAG)&#39;</span>
</span></span></code></pre></div><h1 id="2-create-and-deploy-the-infrastructure-needed-on-aws">2. Create and deploy the infrastructure needed on AWS</h1>
<p>I decided to use AWS CDK to create all the AWS related infrastructure.<br>
I&rsquo;m not going to show the CDK app that I have developed because it&rsquo;s a pretty straightforward one and it will be too much code to paste it in this post, the only thing worth mentioning is that the ECS Task Definition is created referencing the <em>&ldquo;dummy&rdquo;</em> image that I have built in the previous step.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">string</span> DUMMY_IMAGE = <span style="color:#e6db74">&#34;arn:aws:ecr:eu-west-1:1234567789927:repository/dummy&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> FargateTaskDefinition CreateTaskDefinition(
</span></span><span style="display:flex;"><span>        EcsServiceConstructProps props, 
</span></span><span style="display:flex;"><span>        ILogGroup logGroup)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">var</span> task = <span style="color:#66d9ef">new</span> FargateTaskDefinition(<span style="color:#66d9ef">this</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;td-app&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> FargateTaskDefinitionProps
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                Cpu = props.Cpu,
</span></span><span style="display:flex;"><span>                TaskRole = props.TaskDefinitionRole,
</span></span><span style="display:flex;"><span>                ExecutionRole = props.TaskExecutionRole,
</span></span><span style="display:flex;"><span>                Family = props.FamilyName,
</span></span><span style="display:flex;"><span>                MemoryLimitMiB = props.Memory
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        task.AddContainer(<span style="color:#e6db74">&#34;td-app-container&#34;</span>, 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> ContainerDefinitionOptions
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            Cpu = props.Cpu,
</span></span><span style="display:flex;"><span>            MemoryLimitMiB = props.Memory,
</span></span><span style="display:flex;"><span>            Image = ContainerImage.FromEcrRepository(Repository.FromRepositoryArn(<span style="color:#66d9ef">this</span>, 
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;dummy-image&#34;</span>, DUMMY_IMAGE)),
</span></span><span style="display:flex;"><span>            Logging = LogDriver.AwsLogs(<span style="color:#66d9ef">new</span> AwsLogDriverProps
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                StreamPrefix = <span style="color:#e6db74">&#34;ecs&#34;</span>,
</span></span><span style="display:flex;"><span>                LogGroup = logGroup
</span></span><span style="display:flex;"><span>            }),
</span></span><span style="display:flex;"><span>            Environment = GetEnvironmentVariables(props)
</span></span><span style="display:flex;"><span>        }).AddPortMappings(<span style="color:#66d9ef">new</span> PortMapping
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ContainerPort = props.ContainerPort,
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> task;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>The pipeline is quite simple as I&rsquo;m just executing the CDK app.</p>
<p><img alt="cdk-deploy" src="/img/cdk-deploy.png"></p>
<p>I&rsquo;m not going to show you the pipeline to deploy a CDK app because I already talked about it in a previous post.<br>
If you want to know how to build an Azure DevOps pipeline that deploys an AWS CDK app you can read my previous post: <a href="https://www.mytechramblings.com/posts/provisioning-aws-resources-using-cdk-azure-devops/">https://www.mytechramblings.com/posts/provisioning-aws-resources-using-cdk-azure-devops/</a></p>
<h1 id="3-deploy-the-application">3. Deploy the application</h1>
<p>The last pipeline is the one in charge of building and deploying the application.</p>
<p><img alt="ecs-update" src="/img/ecs-update.png"></p>
<ul>
<li>The &ldquo;Continuous Integration&rdquo; (CI) creates the docker image, uses the Build Id variable to tag it and finally pushes the image into an ECR repository.</li>
<li>The &ldquo;Continous Deployment&rdquo; (CD) creates a new revision of the ECS Task Definition that points to the image we have just uploaded and updates the ECS Service to use the newly created revision.</li>
</ul>
<p>The tricky part of this pipeline is when we want to create a new revision of the ECS Task Definition and update the ECS Service to reference the new definition.
There are 2 paths we can follow: We can do it everything by ourselves via scripting and the result will be something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>set -e
</span></span><span style="display:flex;"><span>ECR_IMAGE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>AWS_ACCOUNT_ID<span style="color:#e6db74">}</span><span style="color:#e6db74">.dkr.ecr.</span><span style="color:#e6db74">${</span>AWS_DEFAULT_REGION<span style="color:#e6db74">}</span><span style="color:#e6db74">.amazonaws.com/</span><span style="color:#e6db74">${</span>IMAGE_REPO_NAME<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>IMAGE_TAG<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>TASK_DEFINITION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws ecs describe-task-definition --task-definition <span style="color:#e6db74">&#34;</span>$TASK_FAMILY<span style="color:#e6db74">&#34;</span> --region <span style="color:#e6db74">&#34;</span>$AWS_DEFAULT_REGION<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NEW_TASK_DEFINTIION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $TASK_DEFINITION | jq --arg IMAGE <span style="color:#e6db74">&#34;</span>$ECR_IMAGE<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;.taskDefinition | .containerDefinitions[0].image = $IMAGE | del(.taskDefinitionArn) | del(.revision) | del(.status) | del(.requiresAttributes) | del(.compatibilities)&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NEW_TASK_INFO<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws ecs register-task-definition --region <span style="color:#e6db74">&#34;</span>$AWS_DEFAULT_REGION<span style="color:#e6db74">&#34;</span> --cli-input-json <span style="color:#e6db74">&#34;</span>$NEW_TASK_DEFINTIION<span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NEW_REVISION<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo $NEW_TASK_INFO | jq <span style="color:#e6db74">&#39;.taskDefinition.revision&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>aws ecs update-service --cluster <span style="color:#e6db74">${</span>ECS_CLUSTER<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                       --service <span style="color:#e6db74">${</span>SERVICE_NAME<span style="color:#e6db74">}</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>                       --task-definition <span style="color:#e6db74">${</span>TASK_FAMILY<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>NEW_REVISION<span style="color:#e6db74">}</span><span style="color:#e6db74">```</span>
</span></span></code></pre></div><p>Or we can use the <strong>Fargate CLI</strong> : <a href="https://github.com/awslabs/fargatecli">https://github.com/awslabs/fargatecli</a></p>
<p>The fargate CLI is an command-line interface that allows me to streamline the deployment of containers to an existing AWS Fargate cluster.<br>
With the Fargate CLI you can update the ECS Task Definition and the ECS Service simply by running the following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>fargate service deploy <span style="color:#e6db74">${</span>ECS_SERVICE_NAME<span style="color:#e6db74">}</span> --image <span style="color:#e6db74">${</span>ECR_REPOSITORY_ARN<span style="color:#e6db74">}</span>:<span style="color:#e6db74">${</span>TAG<span style="color:#e6db74">}</span> --cluster <span style="color:#e6db74">${</span>FARGATE_CLUSTER_ARN<span style="color:#e6db74">}</span> --region <span style="color:#e6db74">${</span>AWS_DEFAULT_REGION<span style="color:#e6db74">}</span>
</span></span></code></pre></div><p>For simplicity I decided to ran with the Fargate CLI instead of the bash script, I placed the CLI on a separate Git repository.<br>
This pipeline sounds a little more complex, so let me show the end result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">trigger</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">branches</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#ae81ff">master</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">include</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;*&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">exclude</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;azure-pipelines.yml&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">pool</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">vmImage</span>: <span style="color:#e6db74">&#39;ubuntu-latest&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">resources</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">repositories</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">repository</span>: <span style="color:#ae81ff">FargateCliRepository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">git</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#e6db74">&#39;DevOpsTools/ECSToolset&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">ref</span>: <span style="color:#ae81ff">master</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">variables</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">AWS_ACCOUNT_ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">1234567789927</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">APP_NAME</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">chat-app</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">DOCKERFILE_PATH</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">Chat.WebApi/Dockerfile</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">AWS_REGION</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value </span>: <span style="color:#ae81ff">eu-west-1</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">FARGATE_CLUSTER_ARN</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">arn:aws:ecs:$(AWS_REGION):$(AWS_ACCOUNT_ID):cluster/product-dev-cluster</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">SERVICE_NAME</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">chat-app-dev-ecs-svc   </span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ECR_REPOSITORY</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">$(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(APP_NAME)</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">FARGATE_CLI_PATH</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">ECSToolset/fargate-cli/linux64</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">TAG</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">$(Build.BuildId)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">stages</span>:
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">stage</span>: <span style="color:#e6db74">&#39;BuildAndPushToECR&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job</span>: <span style="color:#e6db74">&#39;Build&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:    
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">checkout</span>: <span style="color:#ae81ff">self  </span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo Starting docker build
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        echo  docker build -t $(APP_NAME):$(TAG) -f $(System.DefaultWorkingDirectory)/$(DOCKERFILE_PATH) .
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        docker build -t $(APP_NAME):$(TAG) -f $(System.DefaultWorkingDirectory)/$(DOCKERFILE_PATH) .</span>        
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Run docker build&#39;</span>  
</span></span><span style="display:flex;"><span>   - <span style="color:#f92672">task</span>: <span style="color:#ae81ff">ECRPushImage@1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">displayName</span>:  <span style="color:#ae81ff">Push image to ECR</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">inputs</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS ECR Dev&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;$(AWS_REGION)&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">imageSource</span>: <span style="color:#e6db74">&#39;imagename&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">sourceImageName</span>: <span style="color:#e6db74">&#39;$(APP_NAME)&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">sourceImageTag</span>: <span style="color:#e6db74">&#39;$(TAG)&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">repositoryName</span>: <span style="color:#e6db74">&#39;$(APP_NAME)&#39;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pushTag</span>: <span style="color:#e6db74">&#39;$(TAG)&#39;</span>
</span></span><span style="display:flex;"><span>- <span style="color:#f92672">stage </span>: <span style="color:#e6db74">&#39;DeployToECSFargateCluster&#39;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job</span>:      
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:  
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">checkout</span>: <span style="color:#ae81ff">FargateCliRepository</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">checkout</span>: <span style="color:#ae81ff">self     </span>
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">task</span>: <span style="color:#ae81ff">AWSShellScript@1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">inputs</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS Fargate Dev&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;$(AWS_REGION)&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">scriptType</span>: <span style="color:#e6db74">&#39;inline&#39;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">inlineScript</span>: |<span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            cd $(System.DefaultWorkingDirectory)/$(FARGATE_CLI_PATH)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">            ./fargate service deploy $(SERVICE_NAME) --image $(ECR_REPOSITORY):$(TAG) --cluster $(FARGATE_CLUSTER_ARN) --region $(AWS_REGION)</span>            
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Update Task Definition&#39;</span>
</span></span></code></pre></div><p>As I stated before I ended up building 3 different pipelines instead of a single pipeline that does everything.<br>
The first pipeline is circumstancial, it creates the &ldquo;dummy application&rdquo; and runs just once.<br>
The other 2 pipelines are the important ones: the first one deploys the infrastructure using CDK and the second one deploys the app.</p>
<ul>
<li>And if you want <strong>these 2 pipelines can be merged together into a single one that contains 2 stages.</strong></li>
</ul>
<p>In my case I&rsquo;m not going to do it, for me it&rsquo;s more comfortable having 2 pipelines rathen than a single one and that&rsquo;s because those pipelines are probably going to be maintained by different people.</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://www.mytechramblings.com/posts/moving-this-blog-to-azure-static-webapps/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Testing out the Azure Static Web Apps service. Let&#39;s try to deploy this blog into an static web app</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://www.mytechramblings.com/posts/answering-basic-questions-about-aad-app-registrations/">
                  <span class="button__text">Answering some basic questions about registering applications on Azure Active Directory</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2024 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://www.mytechramblings.com/assets/main.js"></script>
<script src="https://www.mytechramblings.com/assets/prism.js"></script>
<script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
<script>
  kofiWidgetOverlay.draw('carlospons', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Donate',
    'floating-chat.donateButton.background-color': '#ff5f5f',
    'floating-chat.donateButton.text-color': '#fff'
  });
</script>

      
    </div>

    
      
  
    
      
    
  


    
  </body>
</html>
