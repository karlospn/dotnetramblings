<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Provisioning resources on AWS using AWS CDK and Azure DevOps Pipelines :: my tech ramblings — A blog for writing about my techie ramblings</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Introduction First of all let me tell you that I&amp;rsquo;m huge proponent of Terraform as a framework for defining infrastructure in code. One of the things that I like most about Terraform is that not only every major cloud provider (AWS, Azure, GCP) offers their own provider but each day more and more companies are starting to offer their own Terraform providers, and those are great news because with Terraform I can create almost any cloud infrastructure that I want and also a huge array of varied resources such as: VMware vSphere Virtual Machines, RabbitMq Queues, Grafana dashboards amongst many many others."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://www.mytechramblings.com/posts/provisioning-aws-resources-using-cdk-azure-devops/" />





<link rel="stylesheet" href="https://www.mytechramblings.com/assets/style.css">


<link rel="stylesheet" href="https://www.mytechramblings.com/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.mytechramblings.com/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://www.mytechramblings.com/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Provisioning resources on AWS using AWS CDK and Azure DevOps Pipelines"/>
<meta name="twitter:description" content="Introduction First of all let me tell you that I&rsquo;m huge proponent of Terraform as a framework for defining infrastructure in code. One of the things that I like most about Terraform is that not only every major cloud provider (AWS, Azure, GCP) offers their own provider but each day more and more companies are starting to offer their own Terraform providers, and those are great news because with Terraform I can create almost any cloud infrastructure that I want and also a huge array of varied resources such as: VMware vSphere Virtual Machines, RabbitMq Queues, Grafana dashboards amongst many many others."/>



<meta property="og:title" content="Provisioning resources on AWS using AWS CDK and Azure DevOps Pipelines" />
<meta property="og:description" content="Introduction First of all let me tell you that I&rsquo;m huge proponent of Terraform as a framework for defining infrastructure in code. One of the things that I like most about Terraform is that not only every major cloud provider (AWS, Azure, GCP) offers their own provider but each day more and more companies are starting to offer their own Terraform providers, and those are great news because with Terraform I can create almost any cloud infrastructure that I want and also a huge array of varied resources such as: VMware vSphere Virtual Machines, RabbitMq Queues, Grafana dashboards amongst many many others." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.mytechramblings.com/posts/provisioning-aws-resources-using-cdk-azure-devops/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-09-30T10:02:21&#43;02:00" />
<meta property="article:modified_time" content="2020-09-30T10:02:21&#43;02:00" /><meta property="og:site_name" content="my tech ramblings" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="https://www.mytechramblings.com/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">my tech ramblings</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="https://www.mytechramblings.com/posts/provisioning-aws-resources-using-cdk-azure-devops/">Provisioning resources on AWS using AWS CDK and Azure DevOps Pipelines</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-09-30
        </span>

        
          
            



          
        
      

      
      
        <span class="post-read-time">— 12 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://www.mytechramblings.com/tags/aws/">aws</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/cdk/">cdk</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/azure/">azure</a>&nbsp;
        
          #<a href="https://www.mytechramblings.com/tags/devops/">devops</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      
      <h1 id="introduction">Introduction</h1>
<p>First of all let me tell you that I&rsquo;m huge proponent of <strong>Terraform</strong> as a framework for defining infrastructure in code. <br>
One of the things that I like most about Terraform is that not only every major cloud provider (AWS, Azure, GCP) offers their own provider but each day more and more companies are starting to offer their own Terraform providers, and those are great news because with Terraform I can create almost any cloud infrastructure that I want and also a huge array of varied resources such as: VMware vSphere Virtual Machines, RabbitMq Queues, Grafana dashboards amongst many many others.<br>
And let&rsquo;s not forget that building your own Terraform provider it&rsquo;s quite easy, so if you need to create some resources using Terraform but the provider does not exist you can always built it yourself.</p>
<p>Anyways, this post is starting to sound like a sales pitch for Terraform&hellip; So let&rsquo;s stop talking about Terraform and let&rsquo;s make some focus on AWS CDK.</p>
<p>What&rsquo;s AWS CDK?  <strong>AWS CDK</strong> is  another software development framework for defining cloud infrastructure in code.<br>
One of the <strong>main</strong> differences is that it uses AWS CloudFormation for provisioning the resources, in fact we could say that AWS CDK is nothing more than a developing framework built on top of Cloudformation. That means that AWS CDK is a development framework for manage &ldquo;only&rdquo; AWS infrastructure.</p>
<p>And why should we care about AWS CDK?   <br>
Well if you&rsquo;re not a multi-cloud / hybrid-cloud enterprise and you&rsquo;re staying entirely within AWS, then AWS CDK is hands-down a much better option than Terraform. In my opinion Terraform thrives as a &ldquo;jack-of-all trades&rdquo; IaC tool, meanwhile AWS CDK has been built to work specifically with AWS and what it does, it does it right.</p>
<p>And why use AWS CDK instead of Cloudformation?<br>
With AWS CDK you can do the same things you do with Cfn but with much less code and much more quickly.
Also one of the coolest things about AWS CDK is that like Pulumi it uses familiar programming languages (TypeScript, Javascript, Python, Java and .NET) and that&rsquo;s a great point because developers can write with the same language as the rest of their stack.</p>
<p>I&rsquo;m starting to drift away again&hellip;
What I really wanted to show in this post is how you can deploy AWS CDK applications using Azure DevOps.</p>
<h1 id="step-0---initial-setup">Step 0 - Initial setup</h1>
<p>The main topic of these post is about how to deploy an AWS CDK app using Azure DevOps so I&rsquo;m not going to talk about how to build an AWS CDK app, also I&rsquo;m going to assume that the following things are already on place:</p>
<p>1 - You have an <strong>AWS CDK application</strong> ready to be deployed. The application is going to be stored in an Azure DevOps Git Repository.</p>
<p>In my case I&rsquo;m going to use an app from the aws-cdk-samples Github Repo. This one: <a href="https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/ecs/fargate-service-with-auto-scaling">https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/ecs/fargate-service-with-auto-scaling</a></p>
<p>2 - You have already set in your Azure DevOps a <strong>Service Connection</strong> into your AWS account.<br>
Obviously I&rsquo;m also assuming that the service connection have enough permissions to create the resources we are going to provision via CDK.</p>
<p>3 - You have already installed the <strong><em>&ldquo;AWS Toolkit for Azure DevOps</em>&quot;</strong>  installed on your Azure DevOps tenant (<a href="https://marketplace.visualstudio.com/items?itemName=AmazonWebServices.aws-vsts-tools)">https://marketplace.visualstudio.com/items?itemName=AmazonWebServices.aws-vsts-tools)</a>.</p>
<h1 id="step-1----define-the-branching-and-deploy-strategy">Step 1 -  Define the branching and deploy strategy</h1>
<p>I&rsquo;m going for a pretty straight-forward branch strategy.</p>
<ul>
<li>The <strong>master</strong> branch contains the <strong>production source code</strong>.</li>
<li>Every time I want to add a new feature into my CDK app I create a new branch from the master branch.</li>
<li>The new feature is integrated back onto the master branch doing a Pull Request (PR)</li>
</ul>
<p><img src="/img/branching-strategy.png" alt="diagram"></p>
<ul>
<li>We are going to build <strong>2 Azure Pipelines</strong>.</li>
</ul>
<h2 id="pipeline-1-_pull-request-validation-pipeline_"><strong>Pipeline 1: <em>pull request validation pipeline</em></strong></h2>
<p>The pipeline is going to be triggered when we create a PR from any branch to the master branch.<br>
The pipeline is going to execute the following steps:</p>
<ul>
<li>Validate the CDK synth output using the cfn-nag (<a href="https://github.com/stelligent/cfn_nag">https://github.com/stelligent/cfn_nag</a>)
<ul>
<li>The cfn-nag tool looks for patterns in CloudFormation templates that may indicate insecure infrastructure. It will look for:
<ul>
<li>IAM rules that are too permissive (wildcards)</li>
<li>Security group rules that are too permissive (wildcards)</li>
<li>Access logs that aren&rsquo;t enabled</li>
<li>Encryption that isn&rsquo;t enabled</li>
<li>Password literals.</li>
</ul>
</li>
</ul>
</li>
<li>Add a comment in the PR specifying with resources are going to be created, modified or deleted.
<ul>
<li>That step is completely <strong>optional</strong> but can be quite useful because the PR reviewer can read the PR comment and know exactly how the infrastructure is going to change once he approves the PR.</li>
</ul>
</li>
</ul>
<h2 id="pipeline-2-_master-branch-deployment-pipeline_"><strong>Pipeline 2: <em>master branch deployment pipeline</em></strong></h2>
<p>When the PR is approved and the code is commited into the master branch and automatic pipeline is triggered.<br>
That pipelines is going to do the following steps:</p>
<ul>
<li>Deploy the code.</li>
</ul>
<h1 id="step-2---building-the-pr-pipeline">Step 2 - Building the PR pipeline</h1>
<p>Let me show you the complete pipeline first:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">trigger</span>:
- <span style="color:#ae81ff">none</span>

<span style="color:#f92672">pool</span>:
  <span style="color:#f92672">vmImage</span>: <span style="color:#e6db74">&#39;ubuntu-latest&#39;</span>

<span style="color:#f92672">steps</span>:

- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">NodeTool@0</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">versionSpec</span>: <span style="color:#e6db74">&#39;12.x&#39;</span>

- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">UseRubyVersion@0</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">versionSpec</span>: <span style="color:#e6db74">&#39;&gt;= 2.4&#39;</span>

- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;Installing packages&#34;
</span><span style="color:#e6db74">    sudo npm install -g aws-cdk
</span><span style="color:#e6db74">    sudo gem install cfn-nag</span>    
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Installing aws cdk and cfn nag&#39;</span>

- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;Installing project dependencies&#34;
</span><span style="color:#e6db74">    sudo npm install
</span><span style="color:#e6db74">    sudo npm run build</span>    
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Installing project dependencies&#39;</span>

- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">AWSShellScript@1</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS DEV ACCOUNT&#39;</span>
    <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;eu-west-1&#39;</span>
    <span style="color:#f92672">scriptType</span>: <span style="color:#e6db74">&#39;inline&#39;</span>
    <span style="color:#f92672">inlineScript</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">      echo &#34;Running validations&#34;
</span><span style="color:#e6db74">      cdk synth -o out
</span><span style="color:#e6db74">      cd out
</span><span style="color:#e6db74">      fname=$(find *.template.json)
</span><span style="color:#e6db74">      echo &#34;Testing output with cfn-nag-scan&#34;
</span><span style="color:#e6db74">      cfn_nag_scan --input-path $fname</span>      
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Validating AWS CDK output&#39;</span>


- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">AWSShellScript@1</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS DEV ACCOUNT&#39;</span>
    <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;eu-west-1&#39;</span>
    <span style="color:#f92672">scriptType</span>: <span style="color:#e6db74">&#39;inline&#39;</span>
    <span style="color:#f92672">inlineScript</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">      echo &#34;Generating CDK diff file&#34;
</span><span style="color:#e6db74">      cdk diff -o out -c aws-cdk:enableDiffNoFail=true --no-color &#34;*&#34; 2&gt;&amp;1 | sed -n &#39;/Resources/,/Outputs/p&#39; | sed &#39;s/├/\+/g; s/│/|/g; s/─/-/g; s/└/`/g&#39; | head -n -1 | tee output.log
</span><span style="color:#e6db74">      sed -i &#39;1 i\```bash&#39; output.log
</span><span style="color:#e6db74">      sed -i -e &#39;$a```&#39; output.log</span>      
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Generating CDK diff file&#39;</span>

- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">PowerShell@2</span>
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#34;Writing Pull Request Comment&#34;</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">targetType</span>: <span style="color:#e6db74">&#34;inline&#34;</span>
    <span style="color:#f92672">script</span>: <span style="color:#ae81ff">|                      </span>
      <span style="color:#ae81ff">try </span>
      {
    
        <span style="color:#ae81ff">Write-Host &#34;Write Pull Request comment&#34;</span>
        <span style="color:#ae81ff">$content = Get-Content -Path .\output.log -Raw -ErrorAction Stop</span>
        <span style="color:#ae81ff">$organization = &#34;cpn&#34; </span>
        <span style="color:#ae81ff">$pullRequestThreadUrl = &#34;https://dev.azure.com/$organization/$(System.TeamProjectId)/_apis/git/repositories/$(Build.Repository.ID)/pullRequests/$(System.PullRequest.PullRequestId)/threads?api-version=5.1&#34;</span>
  
        <span style="color:#ae81ff">Write-Host &#34;PR Uri: $pullRequestThreadUrl&#34;</span>

        <span style="color:#ae81ff">if($Null -eq $content || $content -eq &#34; &#34; || $content -eq &#34;&#34;)</span>
        {
            <span style="color:#ae81ff">$content = &#34;CDK Diff found no resource is going to change&#34;</span>
        }

      <span style="color:#ae81ff">$body = @&#34;</span>
      {
          <span style="color:#f92672">&#34;comments&#34;: </span>[
            {
              <span style="color:#f92672">&#34;parentCommentId&#34;: </span><span style="color:#ae81ff">0</span>,
              <span style="color:#f92672">&#34;content&#34;: </span><span style="color:#e6db74">&#34;$content&#34;</span>,
              <span style="color:#f92672">&#34;commentType&#34;: </span><span style="color:#ae81ff">1</span>
            }
          ],
          <span style="color:#f92672">&#34;status&#34;: </span><span style="color:#ae81ff">4</span> 
      }
      <span style="color:#e6db74">&#34;@
</span><span style="color:#e6db74">     
</span><span style="color:#e6db74">        $response = Invoke-RestMethod -Uri $pullRequestThreadUrl -Method Post -Body $body -ContentType &#34;</span><span style="color:#ae81ff">application/json&#34; -Headers @{Authorization = &#34;Bearer $(System.AccessToken)&#34;}</span>
        <span style="color:#ae81ff">if ($response -ne $Null) {</span>
          <span style="color:#ae81ff">Write-Host &#34;Everything worked&#34;</span>
        }
      }
      <span style="color:#ae81ff">catch {</span>
        <span style="color:#ae81ff">Write-Error $_</span>
        <span style="color:#ae81ff">Write-Error $_.Exception.Message</span>
      }
</code></pre></div><p>Remember that you need to add the pipeline as a <strong><em>&ldquo;build validation&rdquo;</em></strong> of the master branch.
A build validation validates code by pre-merging and building pull request changes.</p>
<p><img src="/img/build-validation.png" alt="build-validation"></p>
<p>Now, let&rsquo;s try to explain step by step what the pipeline is exactly doing.</p>
<p><strong>1 -</strong> We begin setting up which <em>Node</em> version is going to be used by the aws-cdk and which <em>Ruby</em> version is going to be used by the cfn-nag tool.<br>
After setting both versions we install the aws-cdk and cfn-nag packages.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">NodeTool@0</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">versionSpec</span>: <span style="color:#e6db74">&#39;12.x&#39;</span>

- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">UseRubyVersion@0</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">versionSpec</span>: <span style="color:#e6db74">&#39;&gt;= 2.4&#39;</span>

- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;Installing packages&#34;
</span><span style="color:#e6db74">    sudo npm install -g aws-cdk
</span><span style="color:#e6db74">    sudo gem install cfn-nag</span>    
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Installing aws cdk and cfn nag&#39;</span>

</code></pre></div><p><strong>2-</strong>_  In this step we&rsquo;re installing the CDK app dependencies and transpiling the code.<br>
If the CDK app was written in csharp instead of typescript we would be doing &ldquo;dotnet build&rdquo; instead of &ldquo;npm run build&rdquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;Installing project dependencies&#34;
</span><span style="color:#e6db74">    sudo npm install
</span><span style="color:#e6db74">    sudo npm run build</span>    
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Installing project dependencies&#39;</span>
</code></pre></div><p><strong>3-</strong> CDK synth outputs a CloudFormation template in a concrete folder.<br>
By default CDK Synth places the Cfn template in the <em>cdk.out</em> folder, but I don&rsquo;t like default behaviours so I&rsquo;m specifying that I want the Cfn template to be placed in a folder called <em>out</em>.<br>
Afterwards I run the cfn-nag tool passing the Cfn template as a parameter.</p>
<p>The results of cfn-nag scan are dumped to stdout.</p>
<ul>
<li>A failing violation will return a non-zero exit code an stop the pipeline.</li>
<li>A warning will return a zero/success exit code and the pipelines will continue the execution.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">AWSShellScript@1</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS DEV ACCOUNT&#39;</span>
    <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;eu-west-1&#39;</span>
    <span style="color:#f92672">scriptType</span>: <span style="color:#e6db74">&#39;inline&#39;</span>
    <span style="color:#f92672">inlineScript</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">      echo &#34;Running validations&#34;
</span><span style="color:#e6db74">      cdk synth -o out
</span><span style="color:#e6db74">      cd out
</span><span style="color:#e6db74">      fname=$(find *.template.json)
</span><span style="color:#e6db74">      echo &#34;Testing output with cfn-nag-scan&#34;
</span><span style="color:#e6db74">      cfn_nag_scan --input-path $fname</span>      
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Validating AWS CDK output&#39;</span>
</code></pre></div><p>4- CDK diff compares the stack to be deployed with the already deployed stack and show the differences between both of them.<br>
In this step I&rsquo;m storing the CDK diff output in a file called &ldquo;output.log&rdquo;, before saving the output of the CDK diff into the file I&rsquo;m applying some filters.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">AWSShellScript@1</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS DEV ACCOUNT&#39;</span>
    <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;eu-west-1&#39;</span>
    <span style="color:#f92672">scriptType</span>: <span style="color:#e6db74">&#39;inline&#39;</span>
    <span style="color:#f92672">inlineScript</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">      echo &#34;Generating CDK diff file&#34;
</span><span style="color:#e6db74">      cdk diff -o out -c aws-cdk:enableDiffNoFail=true --no-color &#34;*&#34; 2&gt;&amp;1 | sed -n &#39;/Resources/,/Outputs/p&#39; | sed &#39;s/├/\+/g; s/│/|/g; s/─/-/g; s/└/`/g&#39; | head -n -1 | tee output.log
</span><span style="color:#e6db74">      sed -i &#39;1 i\```bash&#39; output.log
</span><span style="color:#e6db74">      sed -i -e &#39;$a```&#39; output.log</span>      
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Generating CDK diff file&#39;</span>

</code></pre></div><p>Let me explain a little the purpose of the filters:</p>
<ul>
<li>The CDK diff command shows quite a lot of information but I only want the information about which resources are going to be created/modified.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"> _sed -n <span style="color:#e6db74">&#39;/Resources/,/Outputs/p&#39;</span>_
</code></pre></div><ul>
<li>The CDK diff output shows an output similar to the Linux &ldquo;tree&rdquo; command so I need to transform the tree output to ASCII otherwise when we create the PR comment we are going to find that some characters are missing.<br>
That seems to be some kind of weird issue with the Azure Devops API.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sed <span style="color:#e6db74">&#39;s/├/\+/g; s/│/|/g; s/─/-/g; s/└/`/g&#39;</span>
</code></pre></div><ul>
<li>Azure DevOps accepts markdown as a PR comment, so that&rsquo;s exactly why I&rsquo;m wrapping the output inside a markdown code block.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  sed -i <span style="color:#e6db74">&#39;1 i\```bash&#39;</span> output.log
  sed -i -e <span style="color:#e6db74">&#39;$a```&#39;</span> output.log
</code></pre></div><p>Let me show you an example at the how the &ldquo;output.log&rdquo; file looks like after applying all the filters.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">  <span style="color:#e6db74">```</span>bash
<span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> AWS::S3::Bucket MyFirstBucket MyFirstBucketB8884501
 +- <span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> DeletionPolicy
 |   +- <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Retain
 |   <span style="color:#e6db74">`</span>- <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Delete
 <span style="color:#e6db74">`</span>- <span style="color:#f92672">[</span>~<span style="color:#f92672">]</span> UpdateReplacePolicy
     +- <span style="color:#f92672">[</span>-<span style="color:#f92672">]</span> Retain
     <span style="color:#e6db74">`</span>- <span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Delete
    <span style="color:#e6db74">```</span>
</code></pre></div><p>5- The last step looks a little bit daunting but it&rsquo;s quite simple.</p>
<p>I&rsquo;m reading the &ldquo;output.log&rdquo; file that I created in the previous step an posting the content as a PR comment using the Azure DevOps API.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Generating CDK diff file&#39;</span>

- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">PowerShell@2</span>
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#34;Write Pull Request Comment&#34;</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">targetType</span>: <span style="color:#e6db74">&#34;inline&#34;</span>
    <span style="color:#f92672">script</span>: <span style="color:#ae81ff">|                      </span>
      <span style="color:#ae81ff">try </span>
      {
    
        <span style="color:#ae81ff">Write-Host &#34;Write Pull Request comment&#34;</span>
        <span style="color:#ae81ff">$content = Get-Content -Path .\output.log -Raw -ErrorAction Stop</span>
        <span style="color:#ae81ff">$organization = &#34;cpn&#34; </span>
        <span style="color:#ae81ff">$pullRequestThreadUrl = &#34;https://dev.azure.com/$organization/$(System.TeamProjectId)/_apis/git/repositories/$(Build.Repository.ID)/pullRequests/$(System.PullRequest.PullRequestId)/threads?api-version=5.1&#34;</span>
  
        <span style="color:#ae81ff">Write-Host &#34;PR Uri: $pullRequestThreadUrl&#34;</span>

        <span style="color:#ae81ff">if($Null -eq $content || $content -eq &#34; &#34; || $content -eq &#34;&#34;)</span>
        {
            <span style="color:#ae81ff">$content = &#34;CDK Diff found no resource is going to change&#34;</span>
        }

      <span style="color:#ae81ff">$body = @&#34;</span>
      {
          <span style="color:#f92672">&#34;comments&#34;: </span>[
            {
              <span style="color:#f92672">&#34;parentCommentId&#34;: </span><span style="color:#ae81ff">0</span>,
              <span style="color:#f92672">&#34;content&#34;: </span><span style="color:#e6db74">&#34;$content&#34;</span>,
              <span style="color:#f92672">&#34;commentType&#34;: </span><span style="color:#ae81ff">1</span>
            }
          ],
          <span style="color:#f92672">&#34;status&#34;: </span><span style="color:#ae81ff">4</span> 
      }
      <span style="color:#e6db74">&#34;@
</span><span style="color:#e6db74">     
</span><span style="color:#e6db74">        $response = Invoke-RestMethod -Uri $pullRequestThreadUrl -Method Post -Body $body -ContentType &#34;</span><span style="color:#ae81ff">application/json&#34; -Headers @{Authorization = &#34;Bearer $(System.AccessToken)&#34;}</span>
        <span style="color:#ae81ff">if ($response -ne $Null) {</span>
          <span style="color:#ae81ff">Write-Host &#34;Everything worked&#34;</span>
        }
      }
      <span style="color:#ae81ff">catch {</span>
        <span style="color:#ae81ff">Write-Error $_</span>
        <span style="color:#ae81ff">Write-Error $_.Exception.Message</span>
      }

</code></pre></div><h1 id="step-4---testing-the-pr-pipeline">Step 4 - Testing the PR pipeline</h1>
<p>I have previously deployed that application : <a href="https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/ecs/fargate-service-with-auto-scaling">https://github.com/aws-samples/aws-cdk-examples/tree/master/typescript/ecs/fargate-service-with-auto-scaling</a>.
To test the PR pipeline I&rsquo;m going to modify the CDK app by adding, updating and deleting some of its resources.</p>
<ul>
<li>I&rsquo;ll start testing the pipeline by adding a new S3 bucket into the CDK app and creating a new PR.<br>
The PR pipeline finishes successfully, but if we drill inside the task where we ran the cfn-nag scan we can see that we have some security warnings that maybe we should try to fix.</li>
</ul>
<p><img src="/img/nag-results.png" alt="nag-scan"></p>
<p>Also if we take a look at the PR comment section a new comment has been created by the pipeline agent.</p>
<p><img src="/img/pr-add-comment.png" alt="pr-add"></p>
<ul>
<li>Next I&rsquo;m going to modify the autoscaling policy and the s3 bucket removal policy.<br>
After applying the changes in the CDK app I create a new PR.<br>
The pipeline finishes successfully and if we take a look at the PR section we can see a new comment has been created.</li>
</ul>
<p><img src="/img/pr-modification-comment.png" alt="pr-edit"></p>
<ul>
<li>Next I&rsquo;m going to delete the s3 bucket, put the autoscaling policy back to the original value and create a new SNS topic.<br>
After applying the changes in the CDK app I create a new PR.<br>
The PR pipeline ends correctly and if we take a look at the PR section we can see a new comment has been created.</li>
</ul>
<p><img src="/img/pr-delete-comment.png" alt="pr-delete"></p>
<ul>
<li>Finally I&rsquo;m going to tidy a little bit the CDK app and do some code refactoring but I&rsquo;m <strong>not going to modify any AWS resource</strong>. After applying some code refactor I create a new  PR.<br>
The PR pipeline ends correctly and if we take a look at the PR section we can see a new comment has been created and is telling us that no resource is going to be modified.</li>
</ul>
<p><img src="/img/pr-nochange-comment.png" alt="pr-nochange"></p>
<h1 id="step-5---building-the-master-branch-integration-pipeline">Step 5 - Building the master branch integration pipeline</h1>
<p>The pipeline will be triggered when the PR is completed and the code is commited to the master branch.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">trigger</span>:
    <span style="color:#f92672">branches</span>:
        <span style="color:#f92672">include</span>:
        - <span style="color:#ae81ff">master</span>
    <span style="color:#f92672">paths</span>:
        <span style="color:#f92672">exclude</span>:
            - <span style="color:#e6db74">&#39;azure-pipelines-pr.yml&#39;</span>
            - <span style="color:#e6db74">&#39;azure-pipelines.yml&#39;</span>
<span style="color:#f92672">pool</span>:
  <span style="color:#f92672">vmImage</span>: <span style="color:#e6db74">&#39;ubuntu-latest&#39;</span>

<span style="color:#f92672">steps</span>:
- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;Installing packages&#34;
</span><span style="color:#e6db74">    sudo npm install -g aws-cdk</span>    
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Installing aws cdk&#39;</span>

- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;Installing project dependencies&#34;
</span><span style="color:#e6db74">    sudo npm install
</span><span style="color:#e6db74">    sudo npm run build</span>    
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Installing project dependencies&#39;</span>

- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">AWSShellScript@1</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS DEV ACCOUNT&#39;</span>
    <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;eu-west-1&#39;</span>
    <span style="color:#f92672">scriptType</span>: <span style="color:#e6db74">&#39;inline&#39;</span>
    <span style="color:#f92672">inlineScript</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">      echo &#34;Deploying App&#34;
</span><span style="color:#e6db74">      cdk deploy --ci --require-approval never</span>      
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Deploying CDK app&#39;</span>
   
</code></pre></div><p>Let me explain every step that the pipeline does.</p>
<p><strong>1 -</strong> First of all I need to exclude the pipeline files because I don&rsquo;t want to trigger this pipeline if I&rsquo;m only updating the YAML files.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">trigger</span>:
    <span style="color:#f92672">branches</span>:
        <span style="color:#f92672">include</span>:
        - <span style="color:#ae81ff">master</span>
    <span style="color:#f92672">paths</span>:
        <span style="color:#f92672">exclude</span>:
            - <span style="color:#e6db74">&#39;azure-pipelines-pr.yml&#39;</span>
            - <span style="color:#e6db74">&#39;azure-pipelines.yml&#39;</span>

</code></pre></div><p><strong>2 -</strong> We are doing exactly the same steps as the previous pipeline:</p>
<ul>
<li>Setting up the Node version for the AWS CDK package.</li>
<li>Installing the AWS-CDK package.</li>
<li>Installing the application dependencies.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;Installing packages&#34;
</span><span style="color:#e6db74">    sudo npm install -g aws-cdk</span>    
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Installing aws cdk&#39;</span>

- <span style="color:#f92672">script</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">    echo &#34;Installing project dependencies&#34;
</span><span style="color:#e6db74">    sudo npm install
</span><span style="color:#e6db74">    sudo npm run build</span>    
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Installing project dependencies&#39;</span>

</code></pre></div><p><strong>3 -</strong> Finally we&rsquo;re deploying the app.<br>
If the CDK needs to create any security resource like IAM users you need to add the flag &ldquo;&ndash;require-approval never&rdquo;, otherwise is going to fail.</p>
<blockquote>
<p>You might want to add a manual intervention step before doing the deploy, in that case you should create an &ldquo;Environment&rdquo; and convert that step into a deployment job.<br>
More info here: <a href="https://docs.microsoft.com/en-us/azure/devops/pipelines/process/environments?view=azure-devops">https://docs.microsoft.com/en-us/azure/devops/pipelines/process/environments?view=azure-devops</a></p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#f92672">task</span>: <span style="color:#ae81ff">AWSShellScript@1</span>
  <span style="color:#f92672">inputs</span>:
    <span style="color:#f92672">awsCredentials</span>: <span style="color:#e6db74">&#39;AWS DEV ACCOUNT&#39;</span>
    <span style="color:#f92672">regionName</span>: <span style="color:#e6db74">&#39;eu-west-1&#39;</span>
    <span style="color:#f92672">scriptType</span>: <span style="color:#e6db74">&#39;inline&#39;</span>
    <span style="color:#f92672">inlineScript</span>: |<span style="color:#e6db74">
</span><span style="color:#e6db74">      echo &#34;Deploying App&#34;
</span><span style="color:#e6db74">      cdk deploy --ci --require-approval never</span>      
  <span style="color:#f92672">displayName</span>: <span style="color:#e6db74">&#39;Deploying CDK app&#39;</span>
   
</code></pre></div>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="https://www.mytechramblings.com/posts/answering-basic-questions-about-aad-app-registrations/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Answering some basic questions about registering applications on Azure Active Directory</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="https://www.mytechramblings.com/posts/centrally-manage-nuget-versions/">
                  <span class="button__text">How to centrally manage NuGet package versions within your solution</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2021 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://www.mytechramblings.com/assets/main.js"></script>
<script src="https://www.mytechramblings.com/assets/prism.js"></script>
<script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="carlospons" data-description="Support me on Buy me a coffee!" data-message="Thanks for visiting my blog. Now you can buy me a coffee!" data-color="#FF5F5F" data-position="Right" data-x_margin="18" data-y_margin="18"></script>

      
    </div>

    
      
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-170300931-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
    
  </body>
</html>
